---
epoch: 1766714654518
modelKey: "gemini-2.5-flash|google"
topic: "API Key Errors"


tags:
  - copilot-conversation
---

**user**: è§£æè¿™æ®µç¬”è®°
[Context: Notes: Typora/Kubernetes ç¬”è®°.md]
[Timestamp: 2025/12/26 10:04:14]

**ai**: 
<errorChunk>401 User not found.</errorChunk>
[Timestamp: 2025/12/26 10:04:15]

**user**: è§£æè¿™æ®µç¬”è®°
[Context: Notes: Typora/Kubernetes ç¬”è®°.md]
[Timestamp: 2025/12/26 10:06:41]

**ai**: 
<errorChunk>401 User not found.</errorChunk>
[Timestamp: 2025/12/26 10:06:42]

**user**: è§£æè¿™æ®µç¬”è®°
[Context: Notes: Obsidian æ’ä»¶.md]
[Timestamp: 2025/12/26 10:23:44]

**ai**: 
<errorChunk>Model request failed: API key is not provided for the model: google/gemini-2.5-flash|openrouterai.</errorChunk>
[Timestamp: 2025/12/26 10:23:44]

**user**: grep  k8s
[Timestamp: 2025/12/26 10:37:33]

**ai**: 
<errorChunk>Model request failed: API key is not provided for the model: google/gemini-2.5-flash|openrouterai.</errorChunk>
[Timestamp: 2025/12/26 10:37:33]

**user**: grep k8s
[Timestamp: 2025/12/26 10:39:21]

**user**: ä½ èƒ½æ£€ç´¢åˆ°æˆ‘ obsidionä¸­çš„å…¨éƒ¨ç¬”è®°å†…å®¹å—
[Timestamp: 2025/12/26 10:40:15]

**ai**: æˆ‘æ— æ³•ç›´æ¥æ£€ç´¢æ‚¨ Obsidian ä¸­çš„å…¨éƒ¨ç¬”è®°å†…å®¹ã€‚æˆ‘åªèƒ½è®¿é—®æ‚¨åœ¨å½“å‰å¯¹è¯ä¸­æ˜ç¡®æä¾›ç»™æˆ‘çš„ç¬”è®°å†…å®¹ï¼Œä¾‹å¦‚é€šè¿‡ `<note_context>` æˆ– `<active_note>` æ ‡ç­¾å‘é€ç»™æˆ‘çš„éƒ¨åˆ†ã€‚

å¦‚æœæ‚¨å¸Œæœ›æˆ‘å‚è€ƒæ‚¨çš„ç¬”è®°ï¼Œè¯·åœ¨æ‚¨çš„æŸ¥è¯¢ä¸­æåŠ `@vault`ï¼Œè¿™æ ·ç³»ç»Ÿä¼šå°è¯•å°†ä¸æ‚¨æŸ¥è¯¢ç›¸å…³çš„ç¬”è®°å†…å®¹æä¾›ç»™æˆ‘ã€‚
[Timestamp: 2025/12/26 10:40:34]

**ai**: ä»¥ä¸‹æ˜¯ç¬”è®°ä¸­åŒ…å« "k8s" çš„è¡Œï¼š

- Kubernetesï¼ˆç®€ç§° k8sï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ã€‚
- etcdï¼šåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨æ•°æ®åº“ï¼Œä½œä¸º Kubernetes çš„â€œæ•°æ®å¤§è„‘â€ï¼ŒæŒä¹…åŒ–å­˜å‚¨æ‰€æœ‰é›†ç¾¤é…ç½®ã€çŠ¶æ€åŠå…ƒæ•°æ®ã€‚
- kube-apiserverï¼šé›†ç¾¤çš„**ç»Ÿä¸€ç½‘å…³**ï¼Œæä¾› RESTful API æ¥å£ï¼ˆé»˜è®¤ç«¯å£ 8443ï¼‰ï¼Œæ˜¯æ‰€æœ‰å†…éƒ¨ç»„ä»¶ä¸å¤–éƒ¨å®¢æˆ·ç«¯ï¼ˆå¦‚ `kubectl`ï¼‰ä¸é›†ç¾¤äº¤äº’çš„å”¯ä¸€å…¥å£ã€‚
- kube-schedulerï¼š**æ™ºèƒ½è°ƒåº¦å™¨**ï¼Œè´Ÿè´£ä¸ºæ–°åˆ›å»ºçš„ Pod åˆ†é…åˆé€‚çš„å·¥ä½œèŠ‚ç‚¹ã€‚
- kube-controller-managerï¼šè¿è¡Œå¤šç§**æ§åˆ¶å™¨**çš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡**æ§åˆ¶å›è·¯**æŒç»­ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼ˆå¦‚ Pod å‰¯æœ¬æ•°ã€èŠ‚ç‚¹çŠ¶æ€ï¼‰ï¼Œå¹¶ä¸ etcd ä¸­å­˜å‚¨çš„æœŸæœ›çŠ¶æ€è¿›è¡Œå¯¹æ¯”ã€‚
- kubeletï¼šèŠ‚ç‚¹ä¸Šçš„**ä»£ç†**ï¼Œè´Ÿè´£æ¥æ”¶æ¥è‡ª Master çš„æŒ‡ä»¤ï¼Œç®¡ç†æœ¬èŠ‚ç‚¹ä¸Š Pod çš„ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚åˆ›å»ºã€é”€æ¯å®¹å™¨ï¼‰ï¼Œå¹¶å®šæœŸå‘ Master æŠ¥å‘ŠèŠ‚ç‚¹ä¸ Pod çŠ¶æ€ã€‚
- Podï¼šKubernetes ä¸­æœ€å°çš„**å¯è°ƒåº¦è®¡ç®—å•å…ƒ**ã€‚
- kube-proxyï¼šèŠ‚ç‚¹ä¸Šçš„**ç½‘ç»œä»£ç†**ï¼Œè´Ÿè´£ç»´æŠ¤ç½‘ç»œè§„åˆ™ï¼ˆå¦‚ iptables/IPVSï¼‰ï¼Œå®ç° Service çš„è™šæ‹Ÿ IP è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‘ç°ä¸ Pod é—´çš„ç½‘ç»œé€šä¿¡ï¼Œç¡®ä¿é›†ç¾¤å†…éƒ¨ç½‘ç»œè¿é€šæ€§ã€‚
- Kubernetes é€šè¿‡**åˆ†å·¥æ˜ç¡®çš„å¾®æœåŠ¡ç»„ä»¶**ï¼Œå®ç°äº†å®¹å™¨åŒ–åº”ç”¨çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è¿ç»´ä¸æ•…éšœæ¢å¤ã€‚
- - k8s éå•ä½“æ¶æ„ï¼Œæ˜¯ç”±å¤šä¸ªå¾®æœåŠ¡ç»„æˆ ï¼›
- - k8s åˆ†ä¸ºæ§åˆ¶ç«¯ï¼ˆä¹Ÿç§°ä¸ºç®¡ç†èŠ‚ç‚¹ã€Masterï¼‰ä¸è¢«æ§åˆ¶ç«¯ï¼ˆå·¥ä½œèŠ‚ç‚¹ã€Workeï¼‰ï¼›
- - etcdï¼šç±»ä¼¼äºæ•°æ®åº“ï¼Œè´Ÿè´£å­˜å‚¨é›†ç¾¤çš„æ‰€æœ‰é…ç½®ä¿¡æ¯å’ŒçŠ¶æ€æ•°æ®ï¼Œé‡‡ç”¨é”®å€¼å¯¹å½¢å¼å­˜å‚¨ã€‚
- - schedulerï¼šæ™ºèƒ½è°ƒåº¦å™¨ï¼Œè´Ÿè´£å†³å®šå®¹å™¨ï¼ˆPodï¼‰åœ¨å“ªä¸ª Worker èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚
- - kube-api-serverï¼šKubernetes çš„â€œç½‘å…³â€ï¼Œæä¾› API æ¥å£ï¼Œå…è®¸å¤–éƒ¨å’Œé›†ç¾¤å†…éƒ¨çš„å„ä¸ªç»„ä»¶è¿›è¡Œé€šä¿¡ã€‚
- - contraller managerï¼šæŒç»­ç›‘æ§é›†ç¾¤çš„å®é™…çŠ¶æ€ï¼Œå¹¶ç¡®ä¿å…¶ä¸æœŸæœ›çŠ¶æ€ä¸€è‡´ã€‚
- - kubeletï¼šKubernetes ä¸­çš„ "ä»£ç†"ï¼Œå®ƒåœ¨æ¯ä¸ª Worker èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè´Ÿè´£æ¥æ”¶ Master èŠ‚ç‚¹çš„æŒ‡ä»¤å¹¶æ‰§è¡Œã€‚
- - podï¼šk8s ä¸­æœ€å°çš„è®¡ç®—å•å…ƒï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼›
- - kube-proxyï¼šè´Ÿè´£åœ¨æ¯ä¸ª Worker èŠ‚ç‚¹ä¸Šç»´æŠ¤ç½‘ç»œè§„åˆ™ï¼Œç®¡ç† Pod é—´çš„ç½‘ç»œé€šä¿¡ã€‚
- ![image-20251210152011740](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251210152011740.png)
- ![image-20251210095515555](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251210095515555.png)
- # éƒ¨ç½²
- #### åŸºäº Docker å®‰è£…
- # æŒ‰ç…§è§„åˆ’é…ç½®ä¿®æ”¹ä¸»æœºåï¼ˆå”¯ä¸€çš„ä¸»æœºåï¼‰
- 10.0.0.100 kubeapi.wang.org kubeapi
- # ä¸»æœºæ—¶é—´åŒæ­¥,é›†ç¾¤çš„ Master å’Œå„ node åŒæ­¥æ—¶é—´
- cat > /etc/modules-load.d/k8s.conf <<'eof'
- cat > /etc/sysctl.d/k8s.conf <<'eof'
-     router_id ha1.wang.org   # åœ¨ ha2 ä¸Šä¸º ha2.wang.org
-     router_id ha2.wang.org   # åœ¨ ha2 ä¸Šä¸º ha2.wang.org
- listen kubernetes-api-6443
- # å…ˆæš‚æ—¶ç¦ç”¨master2å’Œmaster3ï¼Œç­‰kuberneteså®‰è£…å®Œæˆåï¼Œå†å¯ç”¨
- # ä¸‹è½½åœ°å€ï¼šhttps://github.com/Mirantis/cri-dockerd/releases
- sed -i 's#^ExecStart.*#ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image registry.aliyuncs.com/google_containers/pause:3.10.1#' /lib/systemd/system/cri-docker.service
- systemctl enable cri-docker.service     # åœ¨å®éªŒä¸­æˆ‘ä¸å–œæ¬¢åšè¿™ä¸ªé…ç½®ï¼ŒçŸ¥é“å°±è¡Œï¼
- # K8s è½¯ä»¶æºå’Œ kubeadm
- # k8s é›†ç¾¤æ¸…ç©ºæœ¬åœ°è½¯ä»¶æºï¼ˆå¯é€‰ï¼‰
- https://github.com/kubernetes/kubernetes/releases
- # å¯¹k8sé›†ç¾¤åˆ·å…¥ä¸‹é¢çš„æŒ‡ä»¤ï¼ˆæŒ‡å¯¼æ–‡æ¡£è·å–çš„æŒ‡ä»¤ï¼‰
- curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.34/deb/Release.key |
- echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/ /" |
- cat /etc/apt/sources.list.d/kubernetes.list
- # æŸ¥çœ‹å®‰è£… k8s çš„å®‰è£…å·¥å…·ï¼›ï¼ˆè‹¥æ˜¯éœ€è¦åˆ«çš„ç‰ˆæœ¬ï¼Œéœ€è¦æŒ‡å®šç‰ˆæœ¬å·ï¼‰
- apt list kubeadm
- # æŒ‡å®šä¸‰ä¸ªå®‰è£…åŒ…(å…­å° k8s é›†ç¾¤è®¾å¤‡éƒ½éœ€è¦å®‰è£…)
- apt install -y kubeadm kubelet kubectl
- # å…ˆå®šä¹‰ k8s ç‰ˆæœ¬ï¼ˆå˜é‡ï¼‰ï¼›ç„¶åå¼€å§‹ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹çš„åˆå§‹åŒ–ï¼ˆè¿™ä¸€æ­¥å¾ˆé‡è¦ï¼ï¼‰
- K8S_RELEASE_VERSION=1.34.2
- kubeadm init --kubernetes-version=v${K8S_RELEASE_VERSION} --control-plane-endpoint kubeapi.wang.org --pod-network-cidr 10.244.0.0/16 --service-cidr 10.96.0.0/12 --token-ttl=0 --image-repository registry.aliyuncs.com/google_containers --upload-certs --cri-socket=unix:///run/cri-dockerd.sock
- # åç»­æ·»åŠ èŠ‚ç‚¹ï¼Œè‹¥æ˜¯ Master èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œæ­¤æŒ‡ä»¤ï¼›ï¼ˆå¾ªåºæ‰§è¡Œï¼Œåˆ‡å‹¿å¤šå°è®¾å¤‡åŒæ—¶æ‰§è¡Œï¼ï¼‰
- kubeadm join kubeapi.wang.org:6443 --token a0y2x9.nbu1tnvpzr3n7uox \
- # åç»­æ·»åŠ èŠ‚ç‚¹ï¼Œè‹¥æ˜¯ worker èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œæ­¤æŒ‡ä»¤ï¼ˆå¾ªåºæ‰§è¡Œï¼Œåˆ‡å‹¿å¤šå°è®¾å¤‡åŒæ—¶æ‰§è¡Œï¼ï¼‰
- kubeadm join kubeapi.wang.org:6443 --token a0y2x9.nbu1tnvpzr3n7uox \
- # ä¾æ®åˆå§‹åŒ–å®Œæˆåçš„ç•Œé¢ä¿¡æ¯æç¤ºï¼Œè¿›å…¥ https://kubernetes.io/docs/concepts/cluster-administration/addons/ è§£å†³ç½‘ç»œæ­å»ºé—®é¢˜
- # æ‰§è¡ŒæˆåŠŸåï¼Œk8s é›†ç¾¤èŠ‚ç‚¹çš„çŠ¶æ€å°±ä¼šå˜æˆ Ready
- #### containerd å®‰è£…ï¼ˆä¸»æµï¼‰
- Ubuntu2404
- 10.0.0.101 master1.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 1ï¼ŒMaster å’Œ etcd
- 10.0.0.102 master2.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 2ï¼ŒMaster å’Œ etcd
- 10.0.0.103 master3.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 3ï¼ŒMaster å’Œ etcd
- 10.0.0.104 node1.wang.org   | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 1
- 10.0.0.105 node2.wang.org   | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 2
- 10.0.0.106 node3.wang.org   | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 3
- 10.0.0.107 ha1.wang.org     | K8s ä¸»èŠ‚ç‚¹è®¿é—®å…¥å£ 1ï¼Œæä¾›é«˜å¯ç”¨åŠè´Ÿè½½å‡è¡¡
- 10.0.0.108 ha2.wang.org     | K8s ä¸»èŠ‚ç‚¹è®¿é—®å…¥å£ 2ï¼Œæä¾›é«˜å¯ç”¨åŠè´Ÿè½½å‡è¡¡
- 10.0.0.100 kubeapi.wang.org | VIPï¼Œåœ¨ ha1 å’Œ ha2 ä¸»æœºå®ç°
- # æŒ‰ç…§è§„åˆ’é…ç½®ä¿®æ”¹ä¸»æœºåï¼ˆå”¯ä¸€çš„ä¸»æœºåï¼‰
- 10.0.0.100 kubeapi.wang.org kubeapi
- cat > /etc/modules-load.d/k8s.conf <<'eof'
- cat > /etc/sysctl.d/k8s.conf <<'eof'
-     router_id ha1.wang.org   # åœ¨ ha2 ä¸Šä¸º ha2.wang.org
-     router_id ha2.wang.org   # åœ¨ ha2 ä¸Šä¸º ha2.wang.org
- listen kubernetes-api-6443
- # å…ˆæš‚æ—¶ç¦ç”¨master2å’Œmaster3ï¼Œç­‰kuberneteså®‰è£…å®Œæˆåï¼Œå†å¯ç”¨ (æˆ–è€…masterèŠ‚ç‚¹è£…å®Œåå°±å¯ä»¥å¯åŠ¨)
- # ä¿®æ”¹containerdé…ç½®åŸºäºtoml(Tom's Obvious Minimal Language)æ ¼å¼ï¼štoml.io
- sed -i "s#registry.k8s.io/pause:3.8#registry.aliyuncs.com/google_containers/pause:3.10.1#g" /etc/containerd/config.toml
- # K8s è½¯ä»¶æºå’Œ kubeadm
- # å¯¹k8sé›†ç¾¤åˆ·å…¥ä¸‹é¢çš„æŒ‡ä»¤ï¼ˆæŒ‡å¯¼æ–‡æ¡£è·å–çš„æŒ‡ä»¤ï¼‰
- curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.34/deb/Release.key |
- echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.34/deb/ /" |
- # å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼ˆk8sé›†ç¾¤èŠ‚ç‚¹éƒ½åšæ­¤æ­¥éª¤ï¼‰
- K8S_RELEASE_VERSION=1.34.1 && echo $K8S_RELEASE_VERSION
- apt install -y kubeadm=${K8S_RELEASE_VERSION}-1.1 kubelet=${K8S_RELEASE_VERSION}-1.1 kubectl=${K8S_RELEASE_VERSION}-1.1
- apt list kubeadm kubectl kubelet
- # å…ˆå®šä¹‰ k8s ç‰ˆæœ¬ï¼ˆå˜é‡ï¼‰ï¼›ç„¶åå¼€å§‹ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹çš„åˆå§‹åŒ–ï¼ˆè¿™ä¸€æ­¥å¾ˆé‡è¦ï¼ï¼‰
- K8S_RELEASE_VERSION=1.34.1 && echo $K8S_RELEASE_VERSION
- kubeadm init --kubernetes-version=v${K8S_RELEASE_VERSION} --control-plane-endpoint kubeapi.wang.org --pod-network-cidr 10.244.0.0/16 --service-cidr 10.96.0.0/12 --token-ttl=0 --image-repository registry.aliyuncs.com/google_containers --upload-certs
- # åç»­æ·»åŠ èŠ‚ç‚¹ï¼Œè‹¥æ˜¯ Master èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œæ­¤æŒ‡ä»¤ï¼›ï¼ˆå¾ªåºæ‰§è¡Œï¼Œåˆ‡å‹¿å¤šå°è®¾å¤‡åŒæ—¶æ‰§è¡Œï¼ï¼‰
-   kubeadm join kubeapi.wang.org:6443 --token j1hki3.tt1ouv8u6ey53t2k \
- # åç»­æ·»åŠ èŠ‚ç‚¹ï¼Œè‹¥æ˜¯ worker èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡Œæ­¤æŒ‡ä»¤ï¼ˆå¾ªåºæ‰§è¡Œï¼Œåˆ‡å‹¿å¤šå°è®¾å¤‡åŒæ—¶æ‰§è¡Œï¼ï¼‰
- kubeadm join kubeapi.wang.org:6443 --token ntlpcq.ah6cbssxakx9c58y --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922
- # ä¾æ®åˆå§‹åŒ–å®Œæˆåçš„ç•Œé¢ä¿¡æ¯æç¤ºï¼Œè¿›å…¥è¯¥ç½‘é¡µæ¥å£è§£å†³ç½‘ç»œæ­å»ºé—®é¢˜
- # æ‰§è¡ŒæˆåŠŸåï¼Œk8s é›†ç¾¤èŠ‚ç‚¹çš„çŠ¶æ€å°±ä¼šå˜æˆ Ready
- # flannel ä¸ calico ï¼ˆäºŒé€‰ä¸€ï¼‰
- # å…ˆå®šä¹‰ k8s ç‰ˆæœ¬ï¼ˆå˜é‡ï¼‰ï¼›ç„¶åå¼€å§‹ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹çš„åˆå§‹åŒ–ï¼ˆè¿™ä¸€æ­¥å¾ˆé‡è¦ï¼ï¼‰
- K8S_RELEASE_VERSION=1.34.1 && echo $K8S_RELEASE_VERSION
- kubeadm init --kubernetes-version=v${K8S_RELEASE_VERSION} --control-plane-endpoint kubeapi.wang.org --pod-network-cidr 192.168.0.0/16 --service-cidr 10.96.0.0/12 --token-ttl=0 --image-repository registry.aliyuncs.com/google_containers --upload-certs
- # æ‰§è¡ŒæˆåŠŸåï¼Œk8s é›†ç¾¤èŠ‚ç‚¹çš„çŠ¶æ€å°±ä¼šå˜æˆ Ready
- nerdctl -n k8s.io ps
- #### åŸºäºäºŒè¿›åˆ¶å®‰è£…
- Kubeasz åˆ©ç”¨ Ansible éƒ¨ç½²äºŒè¿›åˆ¶ Kubernetes é«˜å¯ç”¨é›†ç¾¤
- 10.0.0.101 master1.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 1ï¼ŒK8s é›†ç¾¤ etcd èŠ‚ç‚¹ 1
- 10.0.0.102 master2.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 2ï¼ŒK8s é›†ç¾¤ etcd èŠ‚ç‚¹ 2
- 10.0.0.103 master3.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 3ï¼ŒK8s é›†ç¾¤ etcd èŠ‚ç‚¹ 3
- 10.0.0.104 worker1.wang.org | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 1
- 10.0.0.105 worker2.wang.org | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 2
- 10.0.0.106 worker3.wang.org | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 3
- # ä¸‹è½½ kubeasz ä»£ç ã€äºŒè¿›åˆ¶ã€é»˜è®¤ä¸‹è½½å®¹å™¨é•œåƒåˆ°/etc/kubeaszç›®å½•å¹¶åŒæ—¶å®‰è£…Dockerï¼Œï¼ˆæ›´å¤šå…³äº ezdown çš„å‚æ•°ï¼Œè¿è¡Œ./ezdown æŸ¥çœ‹ï¼‰
- du -sh /etc/kubeasz/ ;
- # è¿è¡Œ ezdown è„šæœ¬ï¼Œç”Ÿæˆä¸€ä¸ªå®¹å™¨ kubeaszï¼ˆç”¨äºå®‰è£…k8sé›†ç¾¤çš„å·¥å…·ï¼‰
- dk ezctl new k8s-01
- docker exec -it kubeasz ezctl new k8s-01
- vi /etc/kubeasz/clusters/k8s-01/hosts
- # æŸ¥çœ‹å½“å‰ Kubernetes é›†ç¾¤ä¸­æ‰€æœ‰å‘½åç©ºé—´ï¼ˆNamespaceï¼‰å†… Pod çš„çŠ¶æ€ã€‚
- # åœ¨æ‰€æœ‰ Master + Worker èŠ‚ç‚¹æ‰§è¡Œï¼šæ¸…ç† K8s / CNI / CRI
- # åˆ›å»ºç¬¬äºŒå¥—é›†ç¾¤ k8s-02
- dk ezctl new k8s-01
- vi /etc/kubeasz/clusters/k8s-02/hosts
- # Pod = ä¸šåŠ¡å®¹å™¨ï¼ˆçœŸæ­£è·‘ä½ çš„åº”ç”¨ï¼‰ + Pause å®¹å™¨ï¼ˆåŸºç¡€è®¾æ–½å®¹å™¨ï¼‰		# æ‰€ä»¥è¯´ä¸€ä¸ªPodä¸­æœ€å°‘åº”è¯¥æœ‰ä¸¤ä¸ªå®¹å™¨ï¼›ï¼ˆä¸€ä¸ªå®¹å™¨æ²¡æœ‰æ„ä¹‰ï¼›ï¼‰
- # Pod å†…çš„ä¸šåŠ¡å®¹å™¨è´Ÿè´£è·‘åº”ç”¨ï¼›pause å®¹å™¨ä½œä¸º Pod çš„åŸºç¡€å®¹å™¨ï¼Œè´Ÿè´£åˆ›å»ºå¹¶ç»´æŒç½‘ç»œå’Œå„ç±» Linux Namespaceï¼Œæ˜¯å®ç°å¤šå®¹å™¨å…±äº«ç¯å¢ƒçš„å…³é”®ã€‚
- # Kubernetes é‡Œçš„ restart = å®¹å™¨è¢«åˆ é™¤åé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨å®ä¾‹ï¼›ï¼ˆå®¹å™¨ä¸€æ—¦é€€å‡ºï¼Œé‚£ä¹ˆè¿™ä¸ªå®¹å™¨å°±æ²¡äº†ï¼Œè‡ªç„¶å°±æ²¡æœ‰é‡å¯è¿™ä¸ªæ¦‚å¿µï¼ï¼‰
- kubectl get pod çš„ STATUS ä¸æ˜¯ Kubernetes çš„çœŸå®çŠ¶æ€ï¼Œè€Œæ˜¯ç”± PodPhase + PodCondition + ContainerState ç»¼åˆå¾—å‡ºçš„å¯è¯»ç»“æœã€‚
- Kubernetes å†…ç½®çš„ PodCondition ç±»å‹æ˜¯å›ºå®šçš„ 4 ä¸ªã€‚ Kubernetes å…è®¸æ‰©å±•æ§åˆ¶å™¨ä¸ºå¯¹è±¡æ·»åŠ é¢å¤– Conditionï¼Œå› æ­¤æ•°é‡ä¸æ˜¯å®Œå…¨é”æ­»ã€‚
- Pod å·²è¢« API Server æ¥æ”¶ï¼Œä½† **è¿˜æ²¡å¼€å§‹åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ**ã€‚
- Pod å·²ç»è°ƒåº¦åˆ°èŠ‚ç‚¹ï¼Œå¹¶ä¸” **è‡³å°‘ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œæˆ–æ­£è¦è¿è¡Œ**ã€‚ï¼ˆå¯èƒ½éƒ¨åˆ†å®¹å™¨æ˜¯ Runningï¼Œéƒ¨åˆ†æ­£åœ¨å¯åŠ¨ã€‚ï¼‰
- Pod çš„æ‰€æœ‰å®¹å™¨éƒ½æˆåŠŸé€€å‡ºï¼Œä¸” **é€€å‡ºç ä¸º 0**ï¼Œå¹¶ä¸”ä¸ä¼šè¢«é‡å¯ç­–ç•¥æ‹‰èµ·ï¼ˆRestartPolicy=Never æˆ– OnFailureï¼‰ã€‚
- Pod å†…æœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¸” **é€€å‡ºç é 0** æˆ– RestartPolicy=Never å¯¼è‡´æœ€ç»ˆå¤±è´¥ã€‚
- API Server **æ— æ³•è·å–èŠ‚ç‚¹ä¸Šçš„ Pod çŠ¶æ€**ã€‚
- **PodScheduled**ï¼šPod å·²è¢«è°ƒåº¦å™¨åˆ†é…åˆ°æŸèŠ‚ç‚¹ã€‚
- **Ready**ï¼šPod æ•´ä½“å¯å¯¹å¤–æä¾›æœåŠ¡ï¼ŒService ä¼šå°†å…¶åŠ å…¥è´Ÿè½½åˆ—è¡¨ã€‚
- | ä½ çœ‹åˆ°çš„ STATUSï¼ˆkubectl get podï¼‰ | PodPhaseï¼ˆå›ºå®š5ç§ï¼‰          | PodConditionsï¼ˆ4ç§å›ºå®šç±»å‹ï¼‰                                 | ContainerStateï¼ˆRunning/Waiting/Terminatedï¼‰ | æœ¬è´¨è§£é‡Š                                            |
- | ---------------------------------- | ---------------------------- | ------------------------------------------------------------ | -------------------------------------------- | --------------------------------------------------- |
- | **Pending**                        | Pending                      | PodScheduled=True/False                                      | Waiting                                      | Pod è¿˜æ²¡å‡†å¤‡å¥½è¿è¡Œï¼Œå¯èƒ½åœ¨è°ƒåº¦ã€æ‹‰é•œåƒã€init æœªå®Œæˆ |
- | **ContainerCreating**              | Pending                      | PodScheduled=True                                            | Waiting(reason=ContainerCreating)            | å®¹å™¨æ­£åœ¨åˆ›å»ºï¼ˆæ‹‰é•œåƒã€åˆ›å»º rootfsã€CNI å‡†å¤‡ï¼‰       |
- | **Init:0/1**ï¼ˆæˆ– Init:N/Mï¼‰        | Pending                      | Initialized=False                                            | Waiting/Terminated                           | init å®¹å™¨æ­£åœ¨è¿è¡Œæˆ–å¤±è´¥                             |
- | **Init:Error**                     | Pending                      | Initialized=False                                            | Terminated(reason=Error)                     | init å®¹å™¨å¤±è´¥                                       |
- | **Init:CrashLoopBackOff**          | Pending                      | Initialized=False                                            | Waiting(reason=CrashLoopBackOff)             | init å®¹å™¨åå¤å¯åŠ¨å¤±è´¥                               |
- | **Running**                        | Running                      | PodScheduled=True / Initialized=True / Ready=True / ContainersReady=True | Running                                      | Pod è¿è¡Œæ­£å¸¸                                        |
- | **Completed**                      | Succeeded                    | Ready=False                                                  | Terminated(reason=Completed)                 | æ‰€æœ‰å®¹å™¨æˆåŠŸé€€å‡ºï¼ˆå¸¸è§äº Jobï¼‰                      |
- | **CrashLoopBackOff**               | Runningï¼ˆå¤šæ•°æƒ…å†µï¼‰          | Ready=False / ContainersReady=False                          | Waiting(reason=CrashLoopBackOff)             | ä¸»å®¹å™¨ä¸€ç›´å´©ï¼ŒKubelet åå¤é‡å¯                      |
- | **Error**                          | Failed                       | Ready=False                                                  | Terminated(reason=Error)                     | å®¹å™¨å¼‚å¸¸é€€å‡º                                        |
- | **ImagePullBackOff**               | Pending                      | Ready=False                                                  | Waiting(reason=ImagePullBackOff)             | é•œåƒæ‹‰å–å¤±è´¥ï¼ˆè®¤è¯ã€tagã€ä»“åº“é—®é¢˜ï¼‰                 |
- | **ErrImagePull**                   | Pending                      | Ready=False                                                  | Waiting(reason=ErrImagePull)                 | é•œåƒæ— æ³•æ‰¾åˆ°                                        |
- | **CreateContainerConfigError**     | Pending                      | Ready=False                                                  | Waiting                                      | Pod é…ç½®é”™è¯¯ï¼ˆç¯å¢ƒå˜é‡ã€Mount ç­‰ï¼‰                  |
- | **Terminating**                    | Running / Succeeded / Failed | Ready=False                                                  | Terminated                                   | Pod æ­£åœ¨åˆ é™¤ï¼ˆä¼˜é›…é€€å‡ºé˜¶æ®µï¼‰                        |
- | **Unknown**                        | Unknown                      | æ— æ³•è·å–                                                     | æ— æ³•è·å–                                     | èŠ‚ç‚¹å¤±è”ï¼ŒK8s è·ä¸æ¥å®¹å™¨çŠ¶æ€                        |
- Kubernetes çš„ Pod æœ‰ä¸‰ç§é‡å¯ç­–ç•¥ï¼Œé…ç½®åœ¨ Pod Spec ä¸­ï¼š
- - Alwaysï¼ˆé»˜è®¤ï¼‰ï¼šæ— è®ºå®¹å™¨å› ä¸ºä»€ä¹ˆé€€å‡ºï¼Œéƒ½è¦é‡æ–°å¯åŠ¨å®¹å™¨ã€‚
- 1. livenessProbeï¼ˆå­˜æ´»æ¢é’ˆï¼‰
-    - å¤±è´¥ â‡’ kubelet ä¼š **é‡å¯å®¹å™¨**ã€‚
- 2. readinessProbeï¼ˆå°±ç»ªæ¢é’ˆï¼‰
-    - å¤±è´¥ â‡’ **ä» Service è´Ÿè½½åˆ—è¡¨ä¸­ç§»é™¤**ï¼Œä½†ä¸ä¼šé‡å¯å®¹å™¨ã€‚
- 3. startupProbeï¼ˆå¯åŠ¨æ¢é’ˆï¼‰
-    - startupProbe æˆåŠŸ â‡’ æ‰å¼€å§‹æ‰§è¡Œ liveness å’Œ readinessã€‚
-    - é¿å…åº”ç”¨å¯åŠ¨æ…¢å¯¼è‡´è¢« liveness ä¸€ç›´é‡å¯ã€‚
- cat > pod-liveness-tcpsocket.yaml
- kubectl apply -f pod-liveness-tcpsocket.yaml
- kubectl exec  pod-liveness-tcpsocket --  iptables -AINPUT -p tcp --dport 80 -j REJECT		# è®¾ç½®è¿‡æ»¤ 80 ç«¯å£æ‹’ç»è§„åˆ™
- kubectl get pod -A		# å› ä¸ºæ˜¯åŸºäºç›‘æµ‹80ç«¯å£å¯åŠ¨ï¼Œå¯¹æ­¤è®¾ç½®æ‹’ç»è§„åˆ™ï¼Œå®¹å™¨åº”è¯¥ä¼šä¸€ç›´é‡å¯ï¼›
- kubectl exec  pod-liveness-tcpsocket -- ls /		# é‡å¯ååˆ›å»ºçš„æ–‡ä»¶åº”è¯¥ä¸å­˜åœ¨çš„ï¼ˆå¦‚æœæ²¡æœ‰åšæŒä¹…åŒ–ï¼‰
- kubectl exec pod-liveness-tcpsocket -- iptables -vnL
- kubectl pod-liveness-tcpsocket --iptables -F
- QoSï¼ˆQuality of Serviceï¼‰æ˜¯ Kubernetes ç”¨æ¥åˆ¤æ–­ â€œå½“èŠ‚ç‚¹èµ„æºä¸å¤Ÿæ—¶ï¼Œå…ˆä¿è°ã€å…ˆæ€è°â€çš„ä¸€å¥—ç­‰çº§ä½“ç³»
- - K8s ä¼šæ ¹æ® **Pod ä¸­æ‰€æœ‰å®¹å™¨çš„ resources.requests / limits** **è‡ªåŠ¨è®¡ç®—** QoS Classã€‚
- â€œæ ¸å¿ƒä¸šåŠ¡é€šå¸¸ä½¿ç”¨ Guaranteed QoSâ€
- ğŸ‘‰ **è¿™ç§ Pod åœ¨èµ„æºç´§å¼ æ—¶æœ€æ™šè¢«æ€**
- ğŸ‘‰ **å¯ä»¥â€œçˆ†å‘â€ï¼Œä½†ä¸æ˜¯é“é¥­ç¢—**ï¼›ï¼ˆPod æ— æ³•æ­£å¸¸è¿è¡Œï¼›é‡å¯æ¬¡æ•°å¢åŠ ï¼‰
- ğŸ‘‰ **èŠ‚ç‚¹ä¸€ç´§å¼ ï¼Œå…ˆæ­»çš„å°±æ˜¯å®ƒ**
- 1ï¸âƒ£ `kubectl get pod` â†’ çŠ¶æ€
- 2ï¸âƒ£ `kubectl describe pod`
- # kubelet ä¼šæ ¹æ® Pod çš„ QoSï¼Œè‡ªåŠ¨è®¾ç½®å®¹å™¨è¿›ç¨‹çš„ oom_score_adj
- # QoS æ˜¯ç­–ç•¥ï¼Œoom_score_adj æ˜¯æ€æˆ®å®¹å™¨çš„åˆ€ã€‚
- - scheduler **åªçœ‹ requests**
- - requests å†³å®šï¼šPod èƒ½ä¸èƒ½è¢«è°ƒåº¦
- æç¤º:ä¸ºä¿è¯æ€§èƒ½,ç”Ÿäº§æ¨èRequestså’ŒLimitsè®¾ç½®ä¸ºç›¸åŒçš„å€¼
- è¦å®ç°èµ„æºé™åˆ¶,éœ€è¦å…ˆå®‰è£…metrics-server
- å®˜æ–¹é“¾æ¥ï¼šhttps://github.com/kubernetes-sigs/metrics-server
- # å»ºè®®å®‰è£…metrics-server,å¯ä»¥é€šè¿‡dashboardæŸ¥çœ‹æ›´å¤šçš„ä¿¡æ¯,æ­¤æ­¥å¯é€‰
- # é»˜è®¤æ–‡ä»¶éœ€è¦ä¿®æ”¹æ‰èƒ½å·¥ä½œ,å› ä¸ºé»˜è®¤éœ€è¦å†…éƒ¨è¯ä¹¦éªŒè¯å’Œé•œåƒåœ°å€k8s.gcr.ioæ‰€ä»¥ä¿®æ”¹
- image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.7.2
- # image: registry.k8s.io/metrics-server/metrics-server:v0.8.0		# å°†æ­¤è¡Œæ³¨é‡Š
- kubectl apply -f components.yaml
- cat > pod-limit-request.yaml
- kubectl apply -f pod-limit-request.yaml
- kubectl get pod
- kubectl describe pod pod-limit-request
- kubectl delete -f pod-limit-request.yaml
- kubectl delete limitranges limit-mem-cpu-per-container
- kubectl describe pod pod-limit-request.yaml
- æ¯ä¸ªèŠ‚ç‚¹é»˜è®¤è®¾ç½®æœ€å¤šè¿è¡Œ110ä¸ªpodï¼›ä½†æ˜¯æ­£å¸¸æ¥è¯´ä¸€ä¸ªèŠ‚ç‚¹è¿è¡Œå‡ åä¸ª
- Kubernetes è‡ªå·±ä¸æ§åˆ¶èµ„æºï¼Œ**kubelet è°ƒç”¨ Linux CGroup æ¥é™åˆ¶**ã€‚
- Kubernetes å¯¹ CPU çš„é™åˆ¶é€šè¿‡ï¼š
- `limits.cpu = 0.5` æ ¸ â†’ kubelet è®¾ç½®ï¼š
- K8s æ ‡è®°ä¸º `OOMKilled`
- å¦‚æœç”¨æˆ·æäº¤çš„ Pod è¿å LimitRangeï¼š
- é˜²æ­¢ä¸šåŠ¡æ–¹æäº¤ä¸€ä¸ª â€œå…¨ç©ºèµ„æºâ€ çš„ Podï¼Œå¯¼è‡´æŠŠèŠ‚ç‚¹æ‰“æ»¡ã€‚
- 1ï¼‰æ‰€æœ‰ç”Ÿäº§å‘½åç©ºé—´å¿…é¡»è®¾ç½® LimitRange + ResourceQuota
- - é˜²æ­¢å®¹å™¨ç©ºé…ç½®åƒæ‰æ•´ä¸ª node
- #### å•å®¹å™¨ Pod
- #### Sidecar æ¨¡å¼
- Pod
- - è®¾è®¡ç†å¿µï¼šç»™ä¸»å®¹å™¨â€œå¤–æŒ‚ä¸€ä¸ªåŠŸèƒ½â€ï¼Œ ä½†ä¸æ”¹ä¸»å®¹å™¨ä»£ç ï¼›
- - ä¸ºä»€ä¹ˆæ”¾åŒä¸€ä¸ª Podï¼Ÿ
- ğŸ‘‰ **è¿™æ˜¯ Pod è®¾è®¡çš„çµé­‚æ¨¡å¼**
- #### Ambassador æ¨¡å¼
- Pod
- #### Adapter æ¨¡å¼
- Pod
- ğŸ‘‰ **åº”ç”¨ä¸æ”¹ï¼Œå¹³å°ä¸€è‡´**
- - Sidecar ä¸ Pod ç»ˆæ­¢é¡ºåºæ˜¯â€œåŒæ—¶â€çš„ï¼›æ—¥å¿— Sidecar è¦èƒ½å¤„ç† SIGTERMï¼›envoy è¦æ”¯æŒä¼˜é›…ä¸‹çº¿
- - èµ„æºé™åˆ¶éå¸¸å…³é”®ï¼ˆå¾ˆå¤šäººä¼šæ¼ï¼‰ï¼›æ¯ä¸ªå®¹å™¨éƒ½æœ‰ `requests / limits`ï¼›Sidecar **èµ„æºæ˜æ˜¾å°äºä¸šåŠ¡å®¹å™¨**
- apiVersion: v1
- kind: Pod
- kubectl run pod-label-nginx --image=wangxiaochun/nginx:1.20.0 -l "app=nginx,env=prod"
- kubectl label pod pod-label-nginx release=1.20.0 role=web
- kubectl label pod pod-label-nginx role=proxy --overwrite
- kubectl label pod pod-label-nginx role- release-pod/pod-label-nginx labeled
- æ§åˆ¶å™¨ä¸è®¤ Pod åå­—ï¼Œåªè®¤ Labelã€‚
- - Deployment
- - ReplicaSet
- - StatefulSet
- - Job
- æ¥å†³å®šï¼šğŸ‘‰ **â€œå“ªäº› Pod æ˜¯æˆ‘è¯¥ç®¡çš„â€**
- Deployment æ˜¯æ€ä¹ˆç®¡ç† Pod çš„ï¼Ÿ
- - Pod ä»æ¥ä¸åº”è¯¥è¢«äººç›´æ¥ç®¡ç†
- - Pod æ˜¯ä¸€æ¬¡æ€§æ¶ˆè€—å“ï¼Œæ§åˆ¶å™¨æ‰æ˜¯é•¿æœŸç®¡ç†è€…
- æ§åˆ¶å™¨çš„æœ¬è´¨ï¼šæŒç»­å¯¹æ¯”ã€ŒæœŸæœ›çŠ¶æ€ã€å’Œã€Œå½“å‰çŠ¶æ€ã€ï¼Œå¹¶ä¸æ–­ä¿®æ­£ï¼›
- Pod çš„å®¹å™¨è¿è¡Œæ—¶åªè¦ç¬¦åˆCRIæ ‡å‡†å³å¯,è€Œéå¿…é¡»ä¸ºDockerï¼›
- æ¯ä¸ªPodä¸­çš„å®¹å™¨ä¾èµ–äºä¸€ä¸ªç‰¹æ®Šåä¸ºpauseå®¹å™¨äº‹å…ˆåˆ›å»ºå‡ºå¯è¢«å„åº”ç”¨å®¹å™¨å…±äº«çš„åŸºç¡€ç¯å¢ƒï¼›
- ![image-20251211193304830](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251211193304830.png)
- ç”¨æˆ·é€šè¿‡ kubectl å‘èµ·åˆ›å»º Pod çš„æ“ä½œï¼ŒAPI Server æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå…ˆæŠŠè¿™ä¸ª Pod çš„ä¿¡æ¯å†™å…¥ etcdã€‚
- æ¥ä¸‹æ¥ï¼ŒScheduler ä¼šé€šè¿‡ç›‘å¬ï¼ˆWatchï¼‰API Server çš„å˜åŒ–ï¼Œå‘ç°æœ‰ä¸€ä¸ªæ–°çš„ Pod è¿˜æ²¡æœ‰è¢«è°ƒåº¦ï¼Œäºæ˜¯å¼€å§‹æŒ‘é€‰æœ€åˆé€‚çš„èŠ‚ç‚¹ã€‚é€‰å¥½èŠ‚ç‚¹åï¼ŒScheduler æŠŠâ€œè¿™ä¸ª Pod åº”è¯¥ç”±å“ªä¸ªèŠ‚ç‚¹æ¥è¿è¡Œâ€çš„ç»“æœå†å†™å› API Serverã€‚
- å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ kubelet ä¹Ÿä¼šä¸€ç›´ç›‘å¬ API Serverã€‚å½“æŸä¸ª kubelet å‘ç°â€œè¿™ä¸ª Pod è¢«è°ƒåº¦åˆ°æˆ‘è¿™ä¸ªèŠ‚ç‚¹äº†â€ï¼Œå®ƒå°±ä¼šè°ƒç”¨ containerd æ¥æ‰§è¡Œå®é™…çš„åˆ›å»ºåŠ¨ä½œï¼šæ‹‰é•œåƒã€åˆ›å»ºå®¹å™¨ã€è®¾ç½®ç½‘ç»œç­‰å·¥ä½œã€‚
- å®¹å™¨å¯åŠ¨ä¹‹åï¼Œkubelet ä¼šä¸æ–­è·å– Pod çš„çœŸå®è¿è¡ŒçŠ¶æ€ï¼Œå¹¶æŠŠè¿™äº›çŠ¶æ€åŒæ­¥ç»™ API Serverã€‚API Server å†æŠŠæœ€æ–°çŠ¶æ€æ›´æ–°åˆ° etcdã€‚
- æœ€ç»ˆï¼Œç”¨æˆ·é€šè¿‡ kubectl æŸ¥è¯¢æ—¶ï¼Œå°±èƒ½çœ‹åˆ° Pod æ­£åœ¨æ€æ ·è¿è¡Œï¼Œè¿™äº›ä¿¡æ¯å…¨éƒ¨æ¥è‡ª etcd ä¸­çš„æœ€æ–°çŠ¶æ€ã€‚
- kubectl api-resources
- kubectl get pod -A
- kubectl get pod -n kube-flannel kube-flannel-ds-8jvfj -o yaml
- kubectl explain pod.metadata
- kubectl create ns duan -o yaml --dry-run=client > duan.yaml
- kubectl apply -f duan.yaml
- kubectl delete ns duan
- kubectl delete pod xxx --grace-period=5
- Pod èµ·ä¸æ¥çš„æ’æŸ¥æ€è·¯ï¼›å¦‚ä½•æŸ¥çœ‹æŠ¥é”™æ—¥å¿—ï¼Ÿ
- Pod åŸºæœ¬åŸç†å’Œå·¥ä½œæœºåˆ¶
- Pod åˆ›å»ºæµç¨‹ï¼ˆæ‰‹å·¥åˆ›å»ºã€è‡ªåŠ¨åˆ›å»ºï¼‰
- Pod å¯åŠ¨ä¸å…³é—­çš„æµç¨‹
- # hook é’©å­ï¼Œå¯ä»¥åœ¨å¯åŠ¨æˆ–è€…é€€å‡ºå‰åšä¸€äº›åŠ¨ä½œï¼
- kubectl exec -it pot-poststart -- sh
- kubectl exec pod-poststart -- ls
- kubectl logs pod-poststart
- # k8s å¯åŠ¨ä¼šè‡ªåŠ¨æ£€ç´¢è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„yamlæ ¼å¼çš„æ¸…å•æ–‡ä»¶
- # YAML æ•°æ®çš„äº”ä¸ªå­—æ®µï¼Œåœ¨ Kubernetes çš„ ä»»æ„èµ„æºå¯¹è±¡é‡Œéƒ½èƒ½çœ‹åˆ°ï¼Œæ˜¯æœ€æ ¸å¿ƒçš„ç»“æ„ï¼šapiVersion  kind  metadata  spec  status
- apiVersion		# è¿™ä¸ªèµ„æºå±äºå“ªä¸ª API ç‰ˆæœ¬ï¼›ç”¨å“ªä¸ª API ç‰ˆæœ¬è§£æ
- kind			# èµ„æºç±»å‹ï¼›ä½ å£°æ˜çš„æ˜¯å“ªç§èµ„æº
- metadata		# å¯¹è±¡çš„å…ƒæ•°æ®ï¼ˆåå­—ã€æ ‡ç­¾ã€æ³¨è§£ã€namespace ç­‰ï¼‰ã€‚å®ƒä¸ä¼šå½±å“ä¸šåŠ¡é€»è¾‘ï¼Œä½†éå¸¸å…³é”®
- spec			# èµ„æºçš„â€œæœŸæœ›çŠ¶æ€â€ï¼ˆä½ æƒ³è¦å®ƒå˜æˆæ€æ ·ï¼‰spec æ˜¯äººä¸ºè®¾å®šçš„ï¼Œå‘Šè¯‰ K8sï¼šæˆ‘è¦å®ƒè¿™æ ·è¿è¡Œã€‚
- status			# èµ„æºçš„â€œå®é™…çŠ¶æ€â€ï¼ˆå½“å‰çœŸå®æƒ…å†µï¼‰ã€‚spec æ˜¯ä½ â€œæƒ³è¦æ€æ ·â€ï¼Œstatus æ˜¯ K8s â€œå½“å‰æ˜¯ä»€ä¹ˆæ ·â€ã€‚
- ç”±workload controller ç®¡æ§çš„podï¼›
- `kubectl` çš„æ‰€æœ‰å‘½ä»¤ï¼Œæœ¬è´¨ä¸Šå¯ä»¥åˆ†æˆ **ä¸‰å¤§ç±»**ã€‚è¿™æ˜¯å­¦ä¹  Kubernetes å¿…é¡»æŒæ¡çš„åŸºç¡€ç»“æ„ï¼Œæˆ‘ç»™ä½ è®²å¾—ç›´æ¥åˆæ¸…æ™°ã€‚
- kubectl get pod
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- kubectl exec â€”â€” è¿›å…¥å®¹å™¨æ‰§è¡Œå‘½ä»¤
- kubectl cp â€”â€” åœ¨ Pod ä¸ä¸»æœºä¹‹é—´æ‹·è´æ–‡ä»¶
- kubectl port-forward â€”â€” è½¬å‘ç«¯å£è°ƒè¯•æœåŠ¡
- kubectl attach â€”â€” é™„åŠ åˆ°æ­£åœ¨è·‘çš„å®¹å™¨
- kubectl debug â€”â€” è°ƒè¯• Podï¼ˆæ–°ç‰ˆï¼‰
- ç”¨æˆ·é€šè¿‡ kubectl å‘èµ·åˆ›å»º Pod çš„æ“ä½œï¼ŒAPI Server æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå…ˆæŠŠè¿™ä¸ª Pod çš„ä¿¡æ¯å†™å…¥ etcdã€‚
- æ¥ä¸‹æ¥ï¼ŒScheduler ä¼šé€šè¿‡ç›‘å¬ï¼ˆWatchï¼‰API Server çš„å˜åŒ–ï¼Œå‘ç°æœ‰ä¸€ä¸ªæ–°çš„ Pod è¿˜æ²¡æœ‰è¢«è°ƒåº¦ï¼Œäºæ˜¯å¼€å§‹æŒ‘é€‰æœ€åˆé€‚çš„èŠ‚ç‚¹ã€‚é€‰å¥½èŠ‚ç‚¹åï¼ŒScheduler æŠŠâ€œè¿™ä¸ª Pod åº”è¯¥ç”±å“ªä¸ªèŠ‚ç‚¹æ¥è¿è¡Œâ€çš„ç»“æœå†å†™å› API Serverã€‚
- å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ kubelet ä¹Ÿä¼šä¸€ç›´ç›‘å¬ API Serverã€‚å½“æŸä¸ª kubelet å‘ç°â€œè¿™ä¸ª Pod è¢«è°ƒåº¦åˆ°æˆ‘è¿™ä¸ªèŠ‚ç‚¹äº†â€ï¼Œå®ƒå°±ä¼šè°ƒç”¨ containerd æ¥æ‰§è¡Œå®é™…çš„åˆ›å»ºåŠ¨ä½œï¼šæ‹‰é•œåƒã€åˆ›å»ºå®¹å™¨ã€è®¾ç½®ç½‘ç»œç­‰å·¥ä½œã€‚
- å®¹å™¨å¯åŠ¨ä¹‹åï¼Œkubelet ä¼šä¸æ–­è·å– Pod çš„çœŸå®è¿è¡ŒçŠ¶æ€ï¼Œå¹¶æŠŠè¿™äº›çŠ¶æ€åŒæ­¥ç»™ API Serverã€‚API Server å†æŠŠæœ€æ–°çŠ¶æ€æ›´æ–°åˆ° etcdã€‚
- æœ€ç»ˆï¼Œç”¨æˆ·é€šè¿‡ kubectl æŸ¥è¯¢æ—¶ï¼Œå°±èƒ½çœ‹åˆ° Pod æ­£åœ¨æ€æ ·è¿è¡Œï¼Œè¿™äº›ä¿¡æ¯å…¨éƒ¨æ¥è‡ª etcd ä¸­çš„æœ€æ–°çŠ¶æ€ã€‚
- Pod IP å°±æŒ‚åœ¨å®ƒèº«ä¸Š
- **Pod å…ˆæœ‰ Pauseï¼Œåæœ‰ä¸šåŠ¡å®¹å™¨**
- å¦‚æœå®šä¹‰äº†æ¢é’ˆï¼šï¼ˆé¦–å…ˆæ‰§è¡Œ startup probe å¯åŠ¨æ¢é’ˆï¼Œç„¶åæ‰æ˜¯ livenessProbe ä¸ readinessProbe ï¼‰
- å¯åŠ¨æ¢é’ˆåœ¨å¯åŠ¨æˆåŠŸåå°±ç»“æŸäº†ï¼Œè€Œ livenessProbe å’Œ readinessProbe ä¼šä¼´éšå®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œç›´åˆ° prestophook é’©å­å¯åŠ¨ï¼›
- åªæœ‰ readiness æˆåŠŸåï¼š
- Pod æ‰ä¼šè¢«æ ‡è®°ä¸º `Ready`
- ğŸ“Œ Service åªä¼šæŠŠæµé‡æ‰“ç»™ Ready çš„ Pod
- kubectl get pod
- **Pod çœŸæ­£å¯ä»¥å¯¹å¤–æœåŠ¡äº†**
- **kubelet æŒç»­ç›¯ç€ï¼Œæ¢é’ˆä¸æ–­æ£€æŸ¥ï¼Œå‡ºäº‹å°±é‡å¯**
- livenessProbeï¼ˆæ´»ç€æ²¡ï¼‰
- readinessProbeï¼ˆèƒ½æ¥æ´»æ²¡ï¼‰
- startupProbeï¼ˆå¯åŠ¨æ¢é’ˆï¼‰
- livenessProbe  | kubelet é‡å¯å®¹å™¨
- readinessProbe | Pod å˜ NotReadyï¼Œä¸æ¥æµé‡
- startupProbe   | å¯åŠ¨æœŸä¿æŠ¤ liveness
- kubectl delete pod xxx
- kubelet å¼€å§‹æ‰§è¡Œ **ä¼˜é›…ç»ˆæ­¢æµç¨‹**ã€‚
- kubelet ä¼šå…ˆæ‰§è¡Œå®ƒã€‚
- kubelet ç›´æ¥ `SIGKILL`
- kubeletï¼š
- APIServerï¼š
- 1. **APIServer åªç®¡è®°è´¦ï¼Œä¸å¹²æ´»**
- 2. **Scheduler åªé€‰èŠ‚ç‚¹ï¼Œä¸åˆ›å»º Pod**
- 3. **kubelet æ˜¯çœŸæ­£å¹²æ´»çš„äºº**
- 4. **Pause å®¹å™¨å…ˆäºä¸šåŠ¡å®¹å™¨å­˜åœ¨**
- 5. **Terminating å¡ä½ = åº”ç”¨ä¸è‚¯é€€å‡º**
- controller-manager é‡Œé¢è·‘ç€å¾ˆå¤šæ§åˆ¶å¾ªç¯ï¼ˆcontroller loopï¼‰ï¼š
- ReplicaSet æ˜¯ Kubernetes ä¸­ç”¨äºç»´æŒ Pod å‰¯æœ¬æ•°é‡çš„æ§åˆ¶å™¨ï¼Œ
- ReplicaSet æ˜¯ Kubernetes ä¸­ç”¨äºç»´æŒ Pod å‰¯æœ¬æ•°é‡çš„æ§åˆ¶å™¨ï¼Œ
- kubectl apply -f controller-replicaset.yaml
- kubectl delete pod controller-replicaset-test-c87m5
- Deployment å¹¶ä¸ç›´æ¥ç®¡ Podï¼Œå®ƒç®¡çš„æ˜¯ **ReplicaSet**ã€‚
- `Deployment` -> `ReplicaSet` -> `Pod`
- SRE åœºæ™¯ï¼šä½ è¦å‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆæ¯”å¦‚ Nginx 1.20 å‡çº§åˆ° 1.21ï¼‰ï¼ŒDeployment ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ RSï¼Œä¸€ç‚¹ç‚¹æŠŠæ—§ RS é‡Œçš„ Pod æŒªåˆ°æ–° RS é‡Œï¼Œè¿™å°±æ˜¯â€œæ»šåŠ¨æ›´æ–°â€ã€‚
- Deployment è´Ÿè´£åˆ›å»º Podï¼ŒService è´Ÿè´£æä¾›è®¿é—®ã€‚
- æ— è®ºæ˜¯ Deployment è¿˜æ˜¯ Serviceï¼Œéƒ½é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å®šä½ Podã€‚
- kubectl create deployment deployment-pod-test --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
- kubectl describe deployment deployment-pod-test		# æŸ¥çœ‹ deployment çš„è¯¦ç»†è¿‡ç¨‹
- kubectl apply -f controller-deployment-test.yaml
- # æ³¨æ„:åˆ›å»ºdeploymentä¼šè‡ªåŠ¨åˆ›å»ºç›¸åº”çš„ RS å’Œ POD
- # RSçš„åç§°=deploymentåç§°+template_hashå€¼
- # æ³¨æ„:Podå=Deploymentå+RSåçš„éšæœºå­—ç¬¦+Podåçš„éšæœºå­—ç¬¦
- kubectl expose deployment deployment-pod-test --port=80
- **æœ€åˆé—®é¢˜ï¼š** å®¿ä¸»æœºæ— æ³•è®¿é—® ClusterIP (`curl 10.98.96.174` å¤±è´¥)ã€‚
- **æ ¹æºè¯Šæ–­ï¼š** `kube-proxy` æ—¥å¿—ä¸­å‡ºç°å¤§é‡çš„ **`Unauthorized`** é”™è¯¯ã€‚
- **æ ¸å¿ƒåŸå› ï¼š** ç”±äº Kubernetes ç‰ˆæœ¬ï¼ˆv1.24+ è¡Œä¸ºï¼‰æˆ–é›†ç¾¤é…ç½®ï¼Œ`kube-system` å‘½åç©ºé—´ä¸‹çš„ `kube-proxy` ServiceAccount ç¼ºå°‘æœ‰æ•ˆçš„ ServiceAccount Tokenï¼Œå¯¼è‡´ `kube-proxy` æ— æ³•é€šè¿‡ RBAC è®¤è¯æ¥è®¿é—® API Serverï¼Œè¿›è€Œæ— æ³•è¯»å– Service å’Œ EndpointSlice ä¿¡æ¯ã€‚
- - ä½¿ç”¨ `kubectl create token kube-proxy -n kube-system --duration 8760h` **åˆ›å»ºäº†ä¸€ä¸ªæœ‰æ•ˆçš„ã€æœ‰ç•Œé™çš„ ServiceAccount ä»¤ç‰Œ**ã€‚
- - é€šè¿‡ `kubectl rollout restart daemonset/kube-proxy -n kube-system` **å¼ºåˆ¶ `kube-proxy` Pods é‡å¯**ã€‚
- - é‡å¯åï¼Œæ–°çš„ `kube-proxy` Podsï¼ˆ`kube-proxy-kzhg8` å’Œ `kube-proxy-qr2ts`ï¼‰æˆåŠŸåœ°å°†æ–°ä»¤ç‰Œä½œä¸º Projected Volume æŒ‚è½½å¹¶ä½¿ç”¨ã€‚
- - æ–°çš„ `kube-proxy` æ—¥å¿—ä¸­**ä¸å†å‡ºç°** `Unauthorized` é”™è¯¯ï¼Œå®ƒä»¬æˆåŠŸåŒæ­¥äº†ç¼“å­˜å¹¶å¯åŠ¨äº† Proxierã€‚
- - å®¿ä¸»æœº Master1 èŠ‚ç‚¹ç°åœ¨å¯ä»¥æˆåŠŸé€šè¿‡ ClusterIP `10.98.96.174` è®¿é—®åç«¯ Pods (`192.168.166.133`, `134`, `135`)ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°æµé‡åœ¨å®ƒä»¬ä¹‹é—´å®ç°äº† **è´Ÿè½½å‡è¡¡**ã€‚
- # åœ¨ kube-system å‘½åç©ºé—´ä¸­ä¸º kube-proxy SA åˆ›å»ºä¸€ä¸ªä»¤ç‰Œ Secret
- kubectl create token kube-proxy -n kube-system --duration 8760h
- # è·å– kube-proxy DaemonSet åç§°:
- kubectl get ds -n kube-system
- # æ‰§è¡Œæ»šåŠ¨é‡å¯ (å¼ºåˆ¶æ›´æ–°é…ç½®):ï¼ˆå‡è®¾ DaemonSet åç§°ä¸º kube-proxyï¼‰
- kubectl rollout restart daemonset/kube-proxy -n kube-system
- kubectl get pod -n kube-system -l k8s-app=kube-proxy -o wide
- # æŸ¥çœ‹æ—¥å¿—ï¼Œæ–°çš„ kube-proxy Pod åç§°
- kubectl logs -n kube-system kube-proxy-kzhg8 ; kubectl logs -n kube-system kube-proxy-qr2ts
- Deployment ç®¡çš„æ˜¯ ReplicaSetï¼Œä¸æ˜¯ Podï¼›
- Deployment â€”â€” ç®¡ç†æ— çŠ¶æ€åº”ç”¨ï¼Œæ”¯æŒæ»šåŠ¨æ›´æ–°ã€å›æ»šã€æ‰©ç¼©å®¹
- DaemonSet â€”â€” â€œæ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªâ€çš„ä»£è¡¨ï¼›æ¯ä¸ª Node æœ€å¤šä¸€ä¸ª
- Deployment
- Deployment çš„ 5 å¤§æ ¸å¿ƒèƒ½åŠ›
- - â‘  å£°æ˜å¼å‘å¸ƒï¼ˆK8s çš„çµé­‚ï¼‰
-   - åªéœ€è¦å£°æ˜ **â€œæˆ‘è¦ä»€ä¹ˆçŠ¶æ€â€**ï¼›K8s è‡ªåŠ¨å®Œæˆï¼šåˆ›å»ºæ–° RSã€ç¼©å®¹æ—§ RSã€å¯¹é½æœ€ç»ˆçŠ¶æ€ï¼›
-   - Deployment é‡‡ç”¨å£°æ˜å¼ç®¡ç†ï¼Œç”¨æˆ·åªæè¿°ç›®æ ‡çŠ¶æ€ã€‚
- - â‘¡ æ»šåŠ¨æ›´æ–°ï¼ˆå¿…é¡»ç²¾é€šï¼‰
-   - RS ä¸ä¼šæ»šåŠ¨æ›´æ–°ï¼ŒDeployment æ‰ä¼š
- - â‘¢ ç‰ˆæœ¬ç®¡ç† & å›æ»šï¼ˆé¢è¯•å®˜æœ€çˆ±ï¼‰
-   - Deployment é€šè¿‡ç®¡ç†å¤šä¸ª ReplicaSet å®ç°ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»šã€‚
-   - å¸¸ç”¨å‘½ä»¤ï¼ˆå¿…é¡»ä¼šï¼‰ï¼š
-     kubectl rollout status deploy nginx
-     kubectl rollout history deploy nginx
-     kubectl rollout undo deploy nginx
-     kubectl rollout undo deploy nginx --to-revision=2
- - â‘£ å¥åº·æ£€æŸ¥ + å‘å¸ƒå®‰å…¨ï¼ˆç”Ÿäº§çº§ï¼‰
-   - æ»šåŠ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼ŒK8s æ ¹æ® readinessProbe åˆ¤æ–­ Pod æ˜¯å¦å¯ç”¨ã€‚ï¼ˆå³ï¼šä»¥Podæ˜¯å¦èƒ½æ¥æ”¶æµé‡ä½œä¸ºæ˜¯å¦å¯ç”¨çš„åˆ¤æ–­æ ‡å‡†ï¼ï¼‰
-   - å¿…å­¦ä¸‰ä»¶å¥—ï¼š
-     livenessProbe:
-     readinessProbe:
-     startupProbe:
- - â‘¤ æ‰©ç¼©å®¹ï¼ˆæ‰‹åŠ¨ & è‡ªåŠ¨ï¼‰
-   - Deployment é€šè¿‡è°ƒæ•´ ReplicaSet çš„ replicas å®ç°æ‰©ç¼©å®¹ã€‚
-   - æ‰‹åŠ¨ï¼š
-     kubectl scale deploy nginx --replicas=5
-   - è‡ªåŠ¨ï¼ˆå¿…é¡»ç†è§£ï¼‰ï¼š
-     - HPAï¼ˆHorizontal Pod Autoscalerï¼‰
- Deployment YAML å¿…é¡»ç†Ÿçš„ç»“æ„ï¼ˆèƒ½é»˜å†™ 80%ï¼‰
- - Deployment çš„ selector **åŒæ ·ä¸å¯ä¹±æ”¹**ï¼Œä½†æ¯” RS å®½å®¹ä¸€ç‚¹ï¼ˆåˆ›å»ºæ—¶ï¼‰ã€‚
- cat > controller-deployment-test.yaml
- kubectl apply -f controller-deployment-test.yaml
- kubectl set image deployment deployment-test pod-test=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2
- kubectl rollout status deploy deployment-test
- kubectl rollout history deployment deployment-test
- kubectl rollout undo deploy deployment-test
- kubectl rollout undo deploy deployment-test --to-revision=1
- kubectl delete pod <deployment-test-pod>
- kubectl describe deploy deployment-test
- kubectl describe rs <rs-name>
- kubectl describe pod <pod-name>
- kubectl expose deployment deployment-test --port=80
- kubectl scale --replicas=5 deployment/deployment-test
- kubectl scale --replicas=3 deployment deployment-test
- vi controller-deployment-test.yaml
- kubectl scale --replicas=1 -f controller-deployment-test.yaml
- kubectl scale --replicas=3 -f controller-deployment-test.yaml
- 1. ä¿®æ”¹ Deployment.spec.template.spec.containers[].image
- 2. Deployment å‘ç° Pod æ¨¡æ¿å˜åŒ–
- 3. åˆ›å»º æ–°çš„ ReplicaSet
- 4. è§¦å‘ æ»šåŠ¨æ›´æ–°
- 5. æ—§ RS ç¼©å®¹ï¼Œæ–° RS æ‰©å®¹
- è‡³æ­¤ `set image` = ä¸€æ¬¡å®Œæ•´çš„æ»šåŠ¨å‘å¸ƒ
- - æ•…æ„å†™é”™ç«¯å£
- - çœ‹ rollout å¡ä½
- - å†ä¿®å¥½ï¼Œç»§ç»­å‘å¸ƒ
- ğŸ‘‰ è¿™æ˜¯ Deployment çš„çµé­‚ã€‚
- kubectl delete deployment deployment-test
- DaemonSet â€”â€”â€œèŠ‚ç‚¹çº§å®ˆæŠ¤è¿›ç¨‹â€	|	æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ª Podï¼ˆæˆ–ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä¸€ä¸ªï¼‰
- kubectl get ds -A
- kubectl get ds -n kube-system calico-node -o yaml
- `StatefulSet` çš„å·¥ä½œæœºåˆ¶
- - **K8S ä¼šä¸ºæ¯ä¸ª Pod ç”Ÿæˆä¸€ä¸ª DNS åŸŸåï¼š `$(podname).$(service_name).$(namespace).svc.cluster.local`**
- - è¿™æ˜¯ STS æœ€ç¡¬æ ¸çš„åœ°æ–¹ã€‚å®ƒä½¿ç”¨äº† VolumeClaimTemplateï¼ˆå·ç”³è¯·æ¨¡æ¿ï¼‰ã€‚
- - ä¸€å¯¹ä¸€ç»‘å®šï¼š å½“ `web-0` å¯åŠ¨æ—¶ï¼ŒSTS ä¼šæ ¹æ®æ¨¡æ¿è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª PVCï¼ˆæ¯”å¦‚ `data-web-0`ï¼‰ã€‚
- - â€œæˆ¿äº§â€ä¸éšäººèµ°ï¼š å¦‚æœ `web-0` è°ƒåº¦åˆ°äº†æœºå™¨ Aï¼Œåæ¥æŒ‚äº†æ¼‚ç§»åˆ°æœºå™¨ Bï¼ŒSTS ä¼šç¡®ä¿åŸæ¥çš„ `data-web-0` é‡æ–°æŒ‚è½½åˆ°æ–°çš„ Pod ä¸Šã€‚
- - æ•°æ®å®‰å…¨ï¼š é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½ åˆ é™¤ StatefulSet æ—¶ï¼Œä¸ºäº†å®‰å…¨ï¼ŒK8S ä¸ä¼šè‡ªåŠ¨åˆ é™¤å¯¹åº”çš„ PVCã€‚ä½ éœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼Œé˜²æ­¢è¯¯åˆ åº“è·‘è·¯ã€‚
- - å¯åŠ¨é¡ºåºï¼š æŒ‰ç´¢å¼• 0 åˆ° N-1 é¡ºåºå¯åŠ¨ã€‚åªæœ‰ `web-0` å˜æˆ Running ä¸” Ready äº†ï¼Œ`web-1` æ‰ä¼šå¼€å§‹åˆ›å»ºã€‚
- - æ›´æ–°ç­–ç•¥ï¼ˆRollingUpdateï¼‰ï¼š æ›´æ–°æ—¶åˆ™æ˜¯é€†åºçš„ã€‚å…ˆåˆ  `web-2`ï¼Œç­‰å®ƒæ›´æ–°å¥½äº†ï¼Œå†åŠ¨ `web-1`ã€‚è¿™æ ·èƒ½ä¿è¯åƒ Elasticsearch è¿™æ ·çš„é›†ç¾¤åœ¨å‡çº§æ—¶ï¼Œå§‹ç»ˆæœ‰è¶³å¤Ÿçš„èŠ‚ç‚¹ç»´æŒæ³•çº¿è¿è¡Œã€‚
- - çº§è”åˆ é™¤ï¼š åˆ é™¤æ—¶ä¹Ÿæ˜¯ä»åå¾€å‰åˆ ã€‚
- CronJob
- # å‘¨æœŸæ€§åˆ›å»º Job
- CronJob
- ç”± kubelet æ‰€è®¾ç½®çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º pod hookï¼›å¯¹äºPodçš„æµç¨‹å¯åŠ¨ä¸å…³é—­ï¼Œä¸»è¦æœ‰ä¸¤ç§é’©å­ï¼š
- é’©å­å¤„ç†ç¨‹åºçš„æ—¥å¿—ä¸ä¼šåœ¨ Pod äº‹ä»¶ä¸­å…¬å¼€ã€‚ å¦‚æœå¤„ç†ç¨‹åºç”±äºæŸç§åŸå› å¤±è´¥ï¼Œå®ƒå°†æ’­æ”¾ä¸€ä¸ªäº‹ä»¶ã€‚
- å¯¹äº PostStartï¼Œè¿™æ˜¯ FailedPostStartHook äº‹ä»¶ï¼Œå¯¹äº PreStopï¼Œè¿™æ˜¯ FailedPreStopHook äº‹ä»¶ã€‚
- å¯ä»¥é€šè¿‡è¿è¡Œå‘½ä»¤æ¥æŸ¥çœ‹è¿™äº›äº‹ä»¶ï¼š kubectl describe pod <pod_name>
- cat > pod-poststart.yaml <<'eof'
- kubectl apply -f pod-poststart.yaml
- kubectl get pod
- kubectl exec pod-poststart -- ls /tmp/ -l
- kubectl logs pod-poststart
- kubectl exec pod-poststart -- cat /tmp/poststart.log
- kubectl delete -f pod-poststart.yaml
- - `postStart` æ˜¯å®¹å™¨ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œåœ¨ **å®¹å™¨åˆšå¯åŠ¨åç«‹å³æ‰§è¡Œ**ï¼›å®ƒä¸ä¼šé˜»å¡å®¹å™¨ä¸»è¿›ç¨‹ï¼Œä½†æ‰§è¡Œå¤±è´¥ä¼šå¯¼è‡´å®¹å™¨å¤±è´¥ï¼ˆCrashLoopBackOffï¼‰
- cat > pod-prestop.yaml <<'eof'
- kubectl apply -f pod-prestop.yaml
- kubectl get pod -o wide
- kubectl delete -f pod-prestop.yaml
- - postStartï¼šå®¹å™¨åˆšå¯åŠ¨ï¼Œå†™å…¥æŒ‚è½½åˆ°å®¿ä¸»æœº `/tmp/poststart.log`
- - preStopï¼šå®¹å™¨ç»ˆæ­¢å‰ï¼Œå†™å…¥æŒ‚è½½å· `/tmp/prestop.log`
- **k8s ä¸ docker çš„åç§°ç©ºé—´æœ‰ä»€ä¹ˆåŒºåˆ«?**
- :star: Kubernetes çš„ Namespace æ˜¯ç”¨æ¥åšé›†ç¾¤èµ„æºçš„é€»è¾‘éš”ç¦»ï¼Œè€Œ Docker çš„ Namespace æ˜¯ Linux å†…æ ¸æä¾›çš„è¿›ç¨‹ã€ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰è¿è¡Œç¯å¢ƒçš„åº•å±‚éš”ç¦»æŠ€æœ¯ï¼Œä¸¤è€…åˆ†åˆ«å·¥ä½œåœ¨ç®¡ç†å±‚å’Œå†…æ ¸å±‚ï¼Œå®Œå…¨ä¸æ˜¯åŒä¸€å±‚é¢çš„æ¦‚å¿µã€‚
- K8s çš„ namespace æ˜¯é›†ç¾¤èµ„æºéš”ç¦»ï¼›Nacos çš„ namespace æ˜¯é…ç½®ä¸æœåŠ¡éš”ç¦»ã€‚
- Docker æœ‰äº”ç§æ ¸å¿ƒç½‘ç»œæ¨¡å¼ï¼šbridgeã€hostã€noneã€container å’Œè‡ªå®šä¹‰ bridgeã€‚é»˜è®¤æ˜¯ bridgeï¼›host æ€§èƒ½æœ€å¥½ï¼›none å®Œå…¨éš”ç¦»ï¼›container å…±äº«ç½‘ç»œæ ˆï¼›è‡ªå®šä¹‰ bridge æœ€å®ç”¨ä¸”æ”¯æŒå®¹å™¨åäº’è®¿ï¼›
- container ç½‘ç»œæ¨¡å‹å’Œ Kubernetes Pod æ¨¡å‹ç±»ä¼¼ï¼ˆå¤šä¸ªå®¹å™¨å…±äº« pause çš„ç½‘ç»œï¼‰ã€‚
- ClusterIP æ˜¯ Kubernetes é›†ç¾¤å†…éƒ¨è®¿é—® Pod çš„ç¨³å®šè™šæ‹Ÿ IPï¼Œæœ¬èº«ä¸è½¬å‘æµé‡ï¼ŒçœŸæ­£è½¬å‘çš„æ˜¯ kube-proxy é€šè¿‡ iptables / ipvs è§„åˆ™å®Œæˆçš„ã€‚
- ClusterIP ä¸€ä¸ªè™šæ‹Ÿ IP ï¼Œåªå­˜åœ¨äº iptables / ipvs è§„åˆ™é‡Œï¼Œç”± kube-proxy ç»´æŠ¤
- è¿™é‡Œçš„ 10.96.100.10 æ˜¯ï¼šService çš„ ClusterIP
- kube-proxy ç›‘å¬ Service / Endpoint å˜åŒ– â†’ å†™ iptables / ipvs è§„åˆ™ï¼›
- kube-proxy ä¸åœ¨æ•°æ®è½¬å‘è·¯å¾„ä¸Šï¼Œå®ƒåªè´Ÿè´£ç»´æŠ¤è½¬å‘è§„åˆ™ã€‚
- kube-proxy æ¥åˆ° k8s é›†ç¾¤å°±åšä¸‰ä»¶äº‹ï¼šç›‘å¬ serviceã€endpointï¼›è®¡ç®—å“ªä¸ªserviceåˆ°å“ªäº›podåç«¯ï¼›å†™å…¥iptablesã€ipvsè§„åˆ™
- Service æ˜¯ä¸€ä¸ªâ€œæœŸæœ›çŠ¶æ€æè¿°å¯¹è±¡â€ ï¼Œæè¿°ä¸‰ä»¶äº‹ï¼šä¸€ä¸ªç¨³å®šå…¥å£ï¼ˆClusterIPï¼‰ï¼›é€‰å“ªäº› Podï¼ˆselectorï¼‰ï¼›æš´éœ²å“ªäº›ç«¯å£ï¼ˆportsï¼‰
- Service è‡ªå·±ä¸å­˜ Pod IP ï¼ŒåŒ¹é… Pod label ï¼Œè‡ªåŠ¨ç”Ÿæˆ Endpoint / EndpointSlice ï¼Œåªé  Endpoint é—´æ¥å…³è” Podã€‚
- Service åªæ˜¯ï¼šå®šä¹‰è§„åˆ™ï¼Œç”Ÿæˆ Endpoint ï¼Œ Service ä¸è´Ÿè½½å‡è¡¡ï¼Œiptables / ipvs æ‰è´Ÿè½½å‡è¡¡
- Pod Networkï¼š å®ç°é›†ç¾¤å†…éƒ¨ä»»æ„ Pod ä¹‹é—´çš„äº’ç›¸é€šä¿¡ã€‚å¿…é¡»ä¾èµ– CNI æ’ä»¶ï¼ˆå¦‚ Flannel, Calico, Weave Net ç­‰ï¼‰æ¥å®ç°è¿™ä¸ªæ‰å¹³åŒ–çš„ç½‘ç»œã€‚
- Service Networkï¼š ä¸ºä¸€ç»„ Pods æä¾›ä¸€ä¸ªç¨³å®šã€ä¸å˜çš„å…¥å£ï¼ˆCluster IPï¼‰ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚
- Ingressï¼ˆå…¥ç«™ï¼‰ï¼š å…è®¸å¤–éƒ¨ç”¨æˆ·è®¿é—®é›†ç¾¤å†…éƒ¨çš„ Serviceã€‚é€šå¸¸é€šè¿‡ NodePortã€LoadBalancer ç±»å‹çš„ Service æˆ– Ingress Controller æ¥å®ç° L7 å±‚çš„æµé‡è·¯ç”±ã€‚
- Egressï¼ˆå‡ºç«™ï¼‰ï¼š å…è®¸é›†ç¾¤å†…éƒ¨çš„ Pods è®¿é—®å¤–éƒ¨äº’è”ç½‘ã€‚è¿™é€šå¸¸ä¾èµ–å®¿ä¸»æœºï¼ˆNodeï¼‰çš„ç½‘ç»œé…ç½®å’Œ NATã€‚
- # æŸ¥çœ‹å½“å‰å®ç° service çš„æ–¹æ³• (é»˜è®¤æ˜¯ iptables è§„åˆ™)
- kubectl create service clusterip åç§° --tcp å†…éƒ¨æš´éœ²çš„ç«¯å£:Pod å®é™…ç«¯å£
- kubectl run test1 --image=busybox -- sleep 500
- kubectl label pod test1 app=myapp
- kubectl create service clusterip myapp --tcp 88:80 --dry-run=client -o yaml		# ç¨³ä¸€æ‰‹ï¼çœ‹ä¸€ä¸‹ selector åº”è¯¥æ˜¯ myapp
- kubectl create service clusterip myapp --tcp 88:80							# è¿™é‡Œçš„ myapp æ—¢æ˜¯ svc åç§°ï¼Œä¹Ÿæ˜¯æ ‡ç­¾
- kubectl edit svc myapp
- # åœ¨ kube-system å‘½åç©ºé—´ä¸­ä¸º kube-proxy SA åˆ›å»ºä¸€ä¸ªä»¤ç‰Œ Secret
- kubectl create token kube-proxy -n kube-system --duration 8760h
- # è·å– kube-proxy DaemonSet åç§°:
- kubectl get ds -n kube-system
- # æ‰§è¡Œæ»šåŠ¨é‡å¯ (å¼ºåˆ¶æ›´æ–°é…ç½®):ï¼ˆå‡è®¾ DaemonSet åç§°ä¸º kube-proxyï¼‰
- kubectl rollout restart daemonset/kube-proxy -n kube-system
- kubectl get pod -n kube-system -l k8s-app=kube-proxy -o wide
- # æŸ¥çœ‹æ—¥å¿—ï¼Œæ–°çš„ kube-proxy Pod åç§°
- kubectl logs -n kube-system kube-proxy-kzhg8 ; kubectl logs -n kube-system kube-proxy-qr2ts
- Endpoint æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ API å¯¹è±¡ï¼Œç”± controller-manager ä¸­çš„ Endpoint Controller ç»´æŠ¤
- Endpoint è®°å½•çš„æ˜¯ï¼šæŸä¸ª Service å½“å‰å®é™…å¯ç”¨çš„ Pod IP + Port åˆ—è¡¨ã€‚
- Endpoint çš„å±€é™æ€§ï¼šå½“ Pod å¾ˆå¤šæ—¶ï¼ˆæ¯”å¦‚ 1000+ï¼‰ä¸€ä¸ª Endpoint å¯¹è±¡ä¼šå¾ˆå¤§ï¼Œetcd å‹åŠ›å¤§ï¼Œkube-proxy åŒæ­¥æ…¢
- EndpointSlice æŠŠä¸€ä¸ª Service çš„åç«¯ Pod åˆ‡æˆå¤šä¸ªâ€œåˆ‡ç‰‡â€å¯¹è±¡ | æœ€å¤§ Pod æ•° ï¼šé»˜è®¤100 | æ–°ç‰ˆæœ¬ kube-proxy ä¼˜å…ˆç›‘å¬ EndpointSlice
- Service å®šä¹‰äº† ClusterIP å’Œåç«¯ Pod é€‰æ‹©å…³ç³»ï¼Œ
- kube-proxy å°†å…¶è½¬åŒ–ä¸º iptables/ipvs ä¸­çš„ DNAT è§„åˆ™ï¼Œ
- è®¿é—® ClusterIP æ—¶ï¼Œå†…æ ¸é€šè¿‡ DNAT å°†æµé‡æ”¹å†™ä¸ºæŸä¸ª PodIP:Portã€‚
- Pod (app=nginx)
- Service (selector: app=nginx)
- Kubernetes ç½‘ç»œ = CNI æ‰“åœ°åŸº + kube-proxy å†™è½¬å‘è§„åˆ™ + NetworkPolicy åšå®‰å…¨æ§åˆ¶
- Flannel è§£å†³â€œPod è·¨èŠ‚ç‚¹é€šä¿¡â€ ï¼Œè®©ä¸åŒ Node ä¸Šçš„ Pod èƒ½äº’ç›¸ ping é€š
- Calico è§£å†³çš„ä¸æ˜¯â€œé€šä¿¡â€ï¼Œè€Œæ˜¯â€œæ§åˆ¶é€šä¿¡â€ | Calico = é«˜æ€§èƒ½ç½‘ç»œ + ç½‘ç»œå®‰å…¨ç­–ç•¥ | Calico é»˜è®¤æ˜¯ è·¯ç”±æ¨¡å¼ï¼ˆBGPï¼‰
- Calico é»˜è®¤ä¸åšéš§é“ï¼Œè€Œæ˜¯é€šè¿‡è·¯ç”±è®© Pod IP å¯è¾¾
- ClusterIP æ˜¯ Kubernetes é›†ç¾¤å†…éƒ¨è®¿é—® Pod çš„ç¨³å®šè™šæ‹Ÿ IP
- NodePort åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæš´éœ²ä¸€ä¸ªç«¯å£ï¼ˆ30000-32767ï¼‰ï¼Œä¾›é›†ç¾¤å¤–éƒ¨è®¿é—®å†…éƒ¨ Podï¼Œå¸¸ç”¨äºæµ‹è¯•ã€‚
- ExternalName ç”¨äºå°†é›†ç¾¤å†… Pod æ˜ å°„åˆ°é›†ç¾¤å¤–çš„æœåŠ¡æˆ–å…¶ä»– Serviceï¼Œå¯ç†è§£ä¸ºâ€œåˆ«åæœåŠ¡â€ã€‚
- LoadBalancer é€‚ç”¨äºé›†ç¾¤éƒ¨ç½²åœ¨æ”¯æŒå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆLBaaSï¼‰çš„ç¯å¢ƒï¼Œä¸º Service æä¾›å¤–éƒ¨è®¿é—®å…¥å£ã€‚éœ€è¦ç¬¬ä¸‰æ–¹è½¯ä»¶ï¼Œç®€ç§° LB
- kubectl create svc loadbalancer myapp --tcp 88:80
- MetalLB ï¼šåœ¨ã€Œæ²¡æœ‰äº‘å‚å•†è´Ÿè½½å‡è¡¡å™¨ã€çš„ Kubernetes é›†ç¾¤é‡Œï¼Œè®© `Service type=LoadBalancer` çœŸçš„æ‹¥æœ‰ä¸€ä¸ªâ€œå¯ä»é›†ç¾¤å¤–è®¿é—®çš„ IPâ€ã€‚
- LBaaS â‰ˆ â€œæˆ‘åˆ›å»ºä¸€ä¸ª Serviceï¼Œç³»ç»Ÿè‡ªåŠ¨ç»™æˆ‘ä¸€ä¸ªå…¬ç½‘ / å¯è®¿é—® IPï¼Œå¹¶å¸®æˆ‘æŠŠæµé‡è½¬å‘åˆ° Podâ€
- - ğŸ‘‰ MetalLB åªè´Ÿè´£ã€Œè¿›é—¨ã€
- - ğŸ‘‰ kube-proxy æ‰è´Ÿè´£ã€Œåˆ†æµã€
- MetalLBï¼ˆARPï¼ŒæŠŠ IP æŒ‡å‘ Nodeï¼‰
- kube-proxyï¼ˆiptables/ipvsï¼‰
- - **å¦‚æœ kube-proxyå·¥ä½œäºipvsæ¨¡å¼ï¼Œå¿…é¡»ä½¿ç”¨ä¸¥æ ¼ARPï¼ˆStrictARPï¼‰æ¨¡å¼ï¼Œå› æ­¤è‹¥æœ‰å¿…è¦ï¼Œå…ˆè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œé…ç½®kube-proxyã€‚**
- - æ­¥éª¤è¯´æ˜ï¼šä¿®æ”¹ `kube-proxy` çš„é…ç½®ï¼šæ‰“å¼€ `strictARP: true`
- kubectl get configmap kube-proxy -n kube-system -o yaml | \
- sed -e "s/strictARP: false/strictARP: true/" | \
- kubectl apply -f - -n kube-system
- kubectl rollout restart ds kube-proxy -n kube-system
- METALLB_VERSION='v0.15.3'
- wget https://raw.githubusercontent.com/metallb/metallb/${METALLB_VERSION}/config/manifests/metallb-native.yaml
- kubectl apply -f metallb-native.yaml		# speaker æ˜¯ DaemonSetï¼›æ„ä¹‰æ˜¯ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½éœ€è¦å¯¹å¤–å®£å‘Š IP
- kubectl get pods -n metallb-system
- æ³¨æ„:ï¼šIPAddressPool **å¿…é¡»ä½äº**
- ä¸Kuberetesé›†ç¾¤èŠ‚ç‚¹ **åŒä¸€äºŒå±‚ç½‘ç»œ**
- **ä½†ä¸èƒ½å ç”¨ä»»ä½•èŠ‚ç‚¹ / ç½‘å…³ / DHCP å·²ä½¿ç”¨çš„ IP**
- cat > service-metallb-IPAddressPool.yaml <<'eof'
- kubectl apply -f service-metallb-IPAddressPool.yaml && kubectl apply -f service-metallb-L2Advertisement.yaml
- kubectl get IPAddressPool -n metallb-system
- kubectl get all -n metallb-system
- kubectl create deployment myapp --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
- kubectl apply -f service-loadbalancer-lbaas.yaml
- kubectl get svc service-loadbalancer-lbaas -o wide
- coredns é…ç½®ï¼›core DNS å·¥ä½œæœºåˆ¶ï¼Œpod çš„ DNS è§£æç­–ç•¥å’Œé…ç½®
- - ç”¨ Calico çš„ NetworkPolicy å…ˆæŠŠ Pod **å…¨éƒ¨é”æ­»**
- - å† **åªæ”¾è¡ŒæŒ‡å®š Pod çš„è®¿é—®**
- kubectl run test1 --image=busybox -- sleep 500
- kubectl run test2 --image=busybox -- sleep 500
- kubectl apply -f deny-all.yaml
- kubectl exec -it test1 -- sh
- # ç»™ test2 æ‰“ã€Œserverã€æ ‡ç­¾ï¼›å…ˆç»™ Pod æ‰“æ ‡ç­¾ï¼ˆéå¸¸å…³é”®ï¼‰
- kubectl label pod test2 role=server
- # ç»™ test1 æ‰“ã€Œclientã€æ ‡ç­¾
- kubectl label pod test1 role=client
- kubectl apply -f allow-client-to-server.yaml
- kubectl apply -f allow-client-egress.yaml
- kubectl exec -it test1 -- ping 192.168.166.130
- kubectl exec -it test2 -- ping 192.168.166.129
- kubectl get networkpolicies
- # æ¸…ç©ºç¯å¢ƒ ï¼ˆæ¨èè¿™ä¸ªæ–¹å¼ï¼‰
- kubectl delete -f deny-all.yaml
- kubectl delete -f allow-client-egress.yaml
- kubectl delete -f allow-client-to-server.yaml
- åœ¨ Kubernetes ä¸­ï¼ŒPodï¼ˆå®¹å™¨ï¼‰é€šå¸¸æ˜¯å†…éƒ¨è¿è¡Œçš„ï¼Œä¸èƒ½ç›´æ¥ä»å¤–éƒ¨è®¿é—®ã€‚è¦è®©å¤–ç•Œå¯ä»¥è®¿é—®è¿™äº› Podï¼Œé€šå¸¸æœ‰ä¸‰ç§æ–¹æ³•ï¼š
- - **ClusterIP**ï¼šä»…é™é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚
- - **NodePort**ï¼šé€šè¿‡èŠ‚ç‚¹çš„ IP å’Œç«¯å£å¯¹å¤–æš´éœ²æœåŠ¡ã€‚
- - **LoadBalancer**ï¼šé€šè¿‡äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨æš´éœ²æœåŠ¡ã€‚
- **Ingress** æ˜¯ Kubernetes ä¸­ç”¨æ¥ç®¡ç†å¤–éƒ¨è®¿é—®é›†ç¾¤å†…æœåŠ¡çš„èµ„æºã€‚å®ƒå……å½“äº†é›†ç¾¤çš„å…¥å£ï¼ŒåŸºäº HTTP æˆ– HTTPS åè®®ï¼Œå¯ä»¥æ ¹æ®è¯·æ±‚çš„ URL è·¯ç”±æµé‡åˆ°ä¸åŒçš„æœåŠ¡ã€‚Ingress éœ€è¦å€ŸåŠ© **Ingress Controller** æ¥å®é™…å¤„ç†æµé‡ã€‚
- **Ingress** æœ¬èº«åªæ˜¯ä¸€ä¸ª**èµ„æºå¯¹è±¡**ï¼ˆä¸€æ®µ YAML é…ç½®ï¼‰ï¼Œå®ƒè§„å®šäº†å¤–éƒ¨æµé‡å¦‚ä½•åˆ°è¾¾é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚è¦è®©å®ƒèµ·ä½œç”¨ï¼Œå¿…é¡»é…åˆ **Ingress Controller**ï¼ˆå¦‚ Nginx Ingress Controllerï¼‰å…±åŒå·¥ä½œã€‚
- **MetalLB** æ˜¯ä¸€ä¸ª Kubernetes çš„è´Ÿè½½å‡è¡¡æ’ä»¶ï¼Œå®ƒå¯ä»¥åœ¨æ²¡æœ‰äº‘è´Ÿè½½å‡è¡¡å™¨çš„æƒ…å†µä¸‹æä¾›ç±»ä¼¼çš„æœåŠ¡ã€‚MetalLB é€šè¿‡é…ç½® IP åœ°å€æ± æ¥ä¸ºæœåŠ¡åˆ†é…å¤–éƒ¨ IP åœ°å€ã€‚å®ƒæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
- - **MetalLB** è´Ÿè´£æä¾›å¤–éƒ¨ IP åœ°å€ï¼Œä½¿å¾— Kubernetes é›†ç¾¤å¯ä»¥æš´éœ²æœåŠ¡ã€‚
- - **Ingress Controller** æ˜¯è´Ÿè´£è§£æ Ingress èµ„æºçš„ç»„ä»¶ï¼Œæ¯”å¦‚ NGINX ã€HAProxy ç­‰ã€‚è¿™ä¸ªç»„ä»¶ä¼šç›‘å¬ Ingress èµ„æºï¼Œå¹¶æ ¹æ®è§„åˆ™å°†æµé‡è·¯ç”±åˆ°ç›¸åº”çš„ Kubernetes æœåŠ¡ã€‚
- - äºŒè€…é…åˆä½¿ç”¨æ—¶ï¼Œ**MetalLB** æä¾›å¤–éƒ¨è®¿é—®å…¥å£ï¼Œè€Œ **Ingress Controller** è´Ÿè´£æ ¹æ®è§„åˆ™è¿›è¡Œæµé‡è·¯ç”±ã€‚
- ### æ€»ç»“ï¼šIngress å°±æ˜¯ä¸€ä¸ªè®¾è®¡å›¾çº¸ï¼Œä½†æ˜¯éœ€è¦ä¸€ä¸ªå·¥ç¨‹å¸ˆéƒ¨ç½²ï¼Œè¿™ä¸ªå·¥ç¨‹å¸ˆå°±æ˜¯æ§åˆ¶å™¨ï¼Ingress Controller
- [Client] --> [MetalLB (LoadBalancer)] --> [Ingress Controller (NGINX)] --> [Service A] (Pod1)
- - **ä¸€å®šè¦çœ‹å®˜æ–¹æ–‡æ¡£è¯´æ˜ï¼ŒæŸ¥çœ‹è¯¥æœåŠ¡ä¸ k8s å“ªäº›ç‰ˆæœ¬å…¼å®¹ï¼**
- ä¸‹è½½é“¾æ¥ï¼š[kubernetes/ingress-nginx: Ingress NGINX Controller for Kubernetes](https://github.com/kubernetes/ingress-nginx/?tab=readme-ov-file)
- # ä¸‹è½½ YAML æ–‡ä»¶
- wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.14.1/deploy/static/provider/cloud/deploy.yaml
- # æ³¨é‡ŠåŸæ¥çš„é•œåƒï¼Œæ·»åŠ å›½å†…é•œåƒæºï¼›ä¿®æ”¹ä¸‰å¤„ image
- image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.14.1
- image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.6.5
- kubectl apply -f deploy.yaml
- # å‡†å¤‡ç¯å¢ƒå®ç°ä¸¤ä¸ª service åº”ç”¨ pod-test1 å’Œ pod-test2
- kubectl create deployment pod-test1 --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
- kubectl create service clusterip pod-test1 --tcp=80:80
- kubectl create deployment pod-test2 --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2 --replicas=3
- kubectl create service clusterip pod-test2 --tcp=80:80
- # åˆ›å»º Ingress è§„åˆ™ ï¼ˆä¸æ¨èï¼‰
- kubectl create ingress ingress-duan --rule=www.duan.org/=pod-test1:80 --class=nginx
- kubectl edit ingress ingress-duan
- kubectl delete ingress ingress-duan
- kubectl create ingress ingress-duan --rule=www.duan.org/*=pod-test1:80 --class=nginx --dry-run=client -o yaml > ingress-duan.yaml
- kubectl apply -f ingress-duan.yaml && kubectl get ingress
- ![image-20251221144745437](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251221144745437.png)
- kubectl delete ingress ingress-duan
- kubectl create ingress demo-ingress1 --rule=www.duan.org/v1=pod-test1:80 --rule=www.duan.org/v2=pod-test2:80  --class=nginx
- kubectl create ingress demo-ingress1 --rule="www.duan.org/v1=pod-test1:80" --rule="www.duan.org/v2=pod-test2:80" --class=nginx --annotation nginx.ingress.kubernetes.io/rewrite-target="/"
- kubectl delete ingress demo-ingress1
- # æ–°ç‰ˆå˜åŒ–ï¼škubernetes-1.32.0 ä»¥åçš„ç‰ˆæœ¬ä½¿ç”¨æŒ‡ä»¤å¼å‘½ä»¤å‡ºé”™ï¼Œæ— æ³•å®ç°ï¼ŒåŸå› ï¼šä¸æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼éœ€è¦ä½¿ç”¨æ¸…å•æ–¹å¼
- kubectl create ingress demo-ingress1 --rule='www.duan.org/v1(/|$)(.*)=pod-test1:80' --rule='www.duan.org/v2(/|$)(.*)=pod-test2:80' --class=nginx --annotation nginx.ingress.kubernetes.io/rewrite-target='/$2' --dry-run=client -o yaml > demo-ingress1.yaml
- kubectl apply -f demo-ingress1.yaml
- # åŸºäºTLSçš„Ingressè¦æ±‚äº‹å…ˆå‡†å¤‡å¥½ä¸“ç”¨çš„â€œkubernetes.io/tlsâ€ç±»å‹çš„Secretèµ„æºå¯¹è±¡
- kubectl create secret tls tls-duan --cert=./www.duan.org.crt --key=./www.duan.org.key
- kubectl create ingress tls-demo-ingress --rule='www.duan.org/*=pod-test1:80,tls=tls-duan' --class=nginx --dry-run=client -o yaml > ingress-tls.yaml
- kubectl apply -f ingress-tls.yaml
- # HTTPS çš„è¯ä¹¦çš„æœ‰æ•ˆæœŸä¸€èˆ¬ä¸º1å¹´,åˆ°æœŸå‰éœ€è¦æå‰æ›´æ–°è¯ä¹¦
- kubectl delete secrets tls-duan
- kubectl create secret tls tls-duan --cert=./duan.crt --key=./duan.key
- kubectl delete  -f ingress-tls.yaml
- kubectl delete svc --all
- kubectl delete deployments.apps --all
- kubectl create ingress ingress-duan --rule=www.duan.org/*=pod-test-v1:80 --class=nginx --dry-run=client -o yaml > ingress-duan.yaml
- kubectl apply -f ingress-duan.yaml && kubectl get ingress
- kubectl apply -f ingress-duan.yaml
- kubectl delete -f canary-by-weight.yaml
- kubectl apply -f ingress-duan.yaml
- kubectl apply -f canary-by-weight.yaml
- kubectl delete -f canary-by-cookie.yaml
- kubectl apply -f ingress-duan.yaml
- kubectl apply -f canary-by-cookie.yaml
- kubectl delete -f canary-by-cookie.yaml && kubectl get ingress
- kubectl apply -f canary-by-header.yaml
- - K8S æŠŠå­˜å‚¨æŠ½è±¡å‡ºæ¥ï¼Œæœ¬è´¨æ˜¯ä¸ºäº†è®©**å¼€å‘**ä¸ç”¨ç®¡åº•å±‚æ˜¯ SSD è¿˜æ˜¯äº‘ç›˜ï¼Œè®©**è¿ç»´**ä¸ç”¨ç®¡å…·ä½“çš„ Pod æ€ä¹ˆæŒ‚è½½ã€‚
- - K8S å­˜å‚¨çš„æœ¬è´¨åªæœ‰ä¸€å¥è¯ï¼šæŠŠâ€œå®¹å™¨é‡Œçš„æ–‡ä»¶å¤¹â€æ˜ å°„åˆ°â€œå¤–é¢çš„çœŸå®ç¡¬ç›˜â€ä¸Šã€‚
- PVC æ˜¯å£°æ˜ï¼ŒPV æ˜¯èµ„æºï¼ŒSC æ˜¯åŠ¨æ€å·¥å‚
- - PV æ˜¯ç¡¬ç›˜å®ä½“ï¼›
- - PVC æ˜¯å­˜å‚¨èµ„æºçš„ç”³è¯·å•ï¼›æ‰€æœ‰ç”Ÿäº§çº§æ•°æ®ï¼Œä¸€å¾‹ä» PVC è¿›
- - StorageClass â€¦â€¦æ€ä¹ˆè¯´å‘¢ï¼ä»¥å‰ PV å¾—æ‰‹åŠ¨åˆ›å»ºï¼Œç°åœ¨æœ‰äº†è¿™ç©æ„ï¼Œåªè¦ PVC ä¸€ç”³è¯·ï¼Œå®ƒè‡ªåŠ¨å»åº•å±‚äº‘å•†é‚£ç»™ä½ æ‹‰å‡ºä¸€å—ç›˜ã€‚
- ä½ åœ¨å®šä¹‰å­˜å‚¨æ—¶ï¼Œå¦‚æœä¸é€‰å¯¹æ¨¡å¼ï¼ŒPod å¯åŠ¨æ—¶èƒ½è®©ä½ æŠ¥é”™æŠ¥åˆ°æ€€ç–‘äººç”Ÿã€‚
- åœ¨ Docker æ—¶ä»£ï¼Œä½ æŒ‚è½½ç›®å½•ç”¨ `-v /data:/data`ã€‚ä½†åœ¨ K8S è¿™ç§é›†ç¾¤ç¯å¢ƒé‡Œï¼ŒPod æ˜¯ä¼šâ€œç¬ç§»â€çš„ï¼ˆåœ¨ä¸åŒèŠ‚ç‚¹æ¼‚ç§»ï¼‰ã€‚å¦‚æœåªç”¨æœ¬åœ°ç›®å½•ï¼ŒPod ä¸€æ¼‚ç§»ï¼Œæ•°æ®å°±ä¸¢äº†ã€‚
- æ‰€ä»¥ K8S å¼•å…¥äº† **ä¸¤å±‚æŠ½è±¡æœºåˆ¶**ï¼š
- 2. é™æ€ä¸åŠ¨æ€ä¾›åº”æœºåˆ¶
- - **é™æ€ï¼ˆStaticï¼‰**ï¼šè¿ç»´è€å“¥æ‰‹åŠ¨å»åˆ†ç›˜ï¼Œåˆ†å¥½ 10Gã€20G çš„ç›˜ç­‰åœ¨é‚£ï¼ˆè¿™å°±æ˜¯ PVï¼‰ã€‚
- - **åŠ¨æ€ï¼ˆDynamicï¼‰**ï¼šè¿ç»´è€å“¥å†™ä¸ªè„šæœ¬ï¼ˆStorageClassï¼‰ï¼Œå¼€å‘ä¸€è¦ç›˜ï¼Œç³»ç»Ÿè‡ªåŠ¨å»åå°åˆ’ä¸€å—å‡ºæ¥ã€‚**è¿™æ˜¯ç›®å‰ç”Ÿäº§ç¯å¢ƒçš„ä¸»æµï¼Œå› ä¸ºè¿ç»´ä¸æƒ³å¤©å¤©è¢«å¼€å‘éªšæ‰°ã€‚**
- 1. ##### ä¸´æ—¶å·¥ï¼š`emptyDir`
- - **æ ¸å¿ƒé€»è¾‘**ï¼šæ•°æ®å­˜æ”¾åœ¨ `kubelet` å·¥ä½œç›®å½•ï¼ŒPod åªè¦ä¸€æ­»ï¼Œæ•°æ®ç›´æ¥ç«åŒ–ã€‚
- - **ä¸æŒä¹…**ã€‚Pod é‡å¯ï¼ˆåªè¦æ²¡è¢«é‡æ–°è°ƒåº¦ï¼‰æ•°æ®è¿˜åœ¨ï¼Œä½† Pod ä¸€æ—¦è¢«åˆ é™¤é‡å»ºï¼Œæ•°æ®ç›´æ¥ç°é£çƒŸç­ã€‚
- - ç¼“å­˜ã€è®¡ç®—ä¸­é—´ä»¶ã€åŒä¸€ Pod å†…å¤šä¸ªå®¹å™¨å…±äº«æ–‡ä»¶ã€‚
- - **æ§½ç‚¹**ï¼šPod åªè¦æ¼‚ç§»åˆ°åˆ«çš„èŠ‚ç‚¹ï¼Œæ•°æ®å°±å¯¹ä¸ä¸Šäº†ã€‚å°±åƒä½ åœ¨ A å®¾é¦†å­˜äº†åŒ…ï¼Œå»äº† B å®¾é¦†æ‰¾å‰å°è¦ï¼Œå‰å°åªä¼šè§‰å¾—ä½ æ˜¯æ¥æ‰¾èŒ¬çš„ã€‚
- è¯„ä»·ï¼šå¹³æ°‘æˆ˜ç¥ã€ä¸‡èƒ½èƒ¶
- 4. ##### ç½‘ç»œå­˜å‚¨
- è¿™æ˜¯é‡ç‚¹ï¼Œå› ä¸ºåªæœ‰ç½‘ç»œå­˜å‚¨æ‰èƒ½è§£å†³ Pod æ¼‚ç§»åçš„æ•°æ®ä¸€è‡´æ€§ã€‚
- **SC çš„ä½œç”¨ï¼š** åœ¨ Local PV é‡Œï¼ŒSC æœ€å¤§çš„ä½œç”¨ä¸æ˜¯â€œåˆ›å»ºç›˜â€ï¼Œè€Œæ˜¯ **â€œæ¨è¿Ÿç»‘å®šâ€**ï¼›å³ï¼šK8S ä¼šç­‰ Pod ç¡®å®šåœ¨å“ªè½æˆ·äº†ï¼Œå†å»æ‰¾é‚£å°æœºå™¨ä¸Šçš„ PV ç»‘å®šã€‚
- **Local Volume (æœ¬åœ°å·æ´¾)**
- **NFS / äº‘ç›˜ (ç½‘ç»œå·æ´¾)**
- - **åˆ¶å¤‡æ–¹å¼** | å¤šä¸º **é™æ€ (Static)**ï¼Œæˆ–åŠè‡ªåŠ¨
- - **æ€§èƒ½**     | **å¤©èŠ±æ¿çº§**ã€‚ç£ç›˜ I/O é›¶æŸè€—
- - **æ•°æ®æ¼«æ¸¸** | **ä¸æ”¯æŒ**ã€‚Pod å¿…é¡»æ­»ç£•è¿™å°æœºå™¨
- - **æ ¸å¿ƒå‚æ•°** | `volumeBindingMode: WaitForFirstConsumer`
- - **å…¸å‹ä»£è¡¨** | æ•°æ®åº“ï¼ˆMySQL/ESï¼‰ã€å¤§æ•°æ®å¤„ç†
- - **åˆ¶å¤‡æ–¹å¼** | ç»å¯¹ **åŠ¨æ€ (Dynamic)**
- - **æ€§èƒ½**     | å—ç½‘ç»œå¸¦å®½å’Œå»¶è¿Ÿé™åˆ¶
- - **æ•°æ®æ¼«æ¸¸** | **æ”¯æŒ**ã€‚å…¨é›†ç¾¤èŠ‚ç‚¹éšä¾¿æ¼‚ç§»
- - **æ ¸å¿ƒå‚æ•°** | `reclaimPolicy: Delete/Retain`
- - **å…¸å‹ä»£è¡¨** | é…ç½®æ–‡ä»¶ã€ç”¨æˆ·ä¸Šä¼ ã€Web é™æ€èµ„æº
- - **é€»è¾‘**ï¼šè¿™ä¸æ˜¯å­˜å‚¨æœ¬èº«ï¼Œè¿™æ˜¯**åˆ›å»ºå­˜å‚¨çš„è§„åˆ™**ã€‚
- - **è‡ªåŠ¨åŒ–**ï¼šå¼€å‘å†™ä¸ª PVC å°±èƒ½è‡ªåŠ¨æ‹¿ç›˜ï¼Œè¿ç»´ä¸ç”¨æ‰‹åŠ¨ `mkdir` å»º PVã€‚
- - **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€äº†å­˜å‚¨ç”³è¯·æµç¨‹ã€‚
- - **é—¨æ§›é«˜**ï¼šä½ å¾—å…ˆéƒ¨ç½²å¯¹åº”çš„ `CSI` é©±åŠ¨ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘ CSIã€Ceph CSIï¼‰ã€‚
- - **ç”Ÿäº§ç”¨é€”**ï¼š**ç›®å‰ 90% ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†é…ç½®**ã€‚
- è¯„ä»·ï¼šè‡ªåŠ¨ææ¬¾æœºã€é«˜çº§çŒå¤´
- **äº‘ç¡¬ç›˜ï¼ˆå…¬æœ‰äº‘ç‹è€…ï¼‰**ï¼š
- - **ä¾‹å­**ï¼šé˜¿é‡Œäº‘ ESSDã€AWS EBSã€‚
- - **ç”Ÿäº§ç°çŠ¶**ï¼š**ç»å¯¹ä¸»æµ**ã€‚ç¨³å®šæ€§æœ€é«˜ï¼Œè¿ç»´æœ€çœå¿ƒï¼ˆä¸ç”¨ä½ è‡ªå·±ä¿®ç¡¬ç›˜ï¼‰ã€‚ç¼ºç‚¹æ˜¯é€šå¸¸åªæ”¯æŒ RWOï¼ˆä¸€ä¸ªç›˜åªèƒ½æŒ‚ç»™ä¸€ä¸ª Podï¼‰ã€‚
- **åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆå¤§å‚è‡ªç ”/ç§æœ‰äº‘ï¼‰**ï¼š
- - **ä»£è¡¨**ï¼šCephã€GlusterFSã€Longhornã€‚
- - **ç”Ÿäº§ç°çŠ¶**ï¼šé«˜ç«¯ç©å®¶ã€‚Ceph å¼ºæ— æ•Œä½†è¿ç»´éš¾åº¦èƒ½è®©ä½ æ‰å¤´å‘ï¼ŒLonghorn æ˜¯ç›®å‰æ¯”è¾ƒç«çš„è½»é‡çº§é€‰æ‹©ã€‚
- **ã€æ‰‹åŠ¨æ—¶ä»£ - è‹¦åŠ›æ´»ã€‘**
- 2. è¿ç»´åœ¨ K8S å»ºç«‹ **PV**ï¼ˆæŒ‡æ˜è¿™ä¸ªç›®å½•æ˜¯ 10Gï¼‰
- 3. å¼€å‘åœ¨ K8S å»ºç«‹ **PVC**ï¼ˆæˆ‘è¦ 10G ç›˜ï¼‰
- 4. K8S å‘ç°ä¸¤ä¸ªæ­£å¥½åŒ¹é…ï¼Œ**Boundï¼ˆç»‘å®šï¼‰**ï¼
- 5. Pod åœ¨å®šä¹‰é‡Œå†™ä¸Šï¼š`volumes: persistentVolumeClaim: claimName: my-pvc`
- **ã€è‡ªåŠ¨æ—¶ä»£ - ç°ä»£è¿ç»´ã€‘**
- 1. è¿ç»´éƒ¨ç½²ä¸€ä¸ª **StorageClass**ï¼ˆå‘Šè¯‰ K8Sï¼šå»æ‰¾é˜¿é‡Œäº‘/Ceph è‡ªåŠ¨è¦ç›˜ï¼‰ã€‚
- 2. å¼€å‘ç›´æ¥å†™ä¸ª **PVC**ï¼Œå¹¶åœ¨é‡Œé¢å†™ä¸Š `storageClassName: fast-disk`ã€‚
- 3. **å¥‡è¿¹å‘ç”Ÿ**ï¼šK8S è‡ªåŠ¨åœ¨åå°å¸®ä½ æŠŠ PV å»ºå¥½äº†ï¼Œç›˜ä¹Ÿä¹°å¥½äº†ï¼Œç›´æ¥å°±èƒ½ç”¨ã€‚
- - **ç”Ÿå‘½å‘¨æœŸ** | `reclaimPolicy`     | ç”Ÿäº§**å¿…é€‰ `Retain`**ï¼ˆä¿ç•™ï¼‰ã€‚è¦æ˜¯é€‰ `Delete`ï¼ŒPVC ä¸€åˆ æ•°æ®å…¨æ²¡ï¼Œåˆ°æ—¶å€™ä½ å°±å¾—å»å¤©å°æ’é˜Ÿäº†ã€‚
- - **è°ƒåº¦ç­–ç•¥** | `volumeBindingMode` | **æœ¬åœ°ç›˜å¿…é€‰ `WaitForFirstConsumer`**ã€‚åˆ«è®© PV çç»‘å®šï¼Œå¾—ç­‰ Pod ç¡®å®šåœ¨å“ªå°æœºå™¨è½åœ°äº†ï¼Œå†æŠŠç›˜åˆ†è¿‡å»ï¼Œå¦åˆ™ Pod è°ƒåº¦ä¸ä¸Šå»ã€‚
- - **è¯»å†™æƒé™** | `accessModes`       | ç»å¤§å¤šæ•°æ•°æ®åº“åªè®¤ `RWO`ã€‚åˆ«å¹»æƒ³ç”¨ `RWX` ç»™å¤šä¸ª MySQL ç”¨ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šç¢ç»™ä½ çœ‹ã€‚
- - **ç‰©ç†å½¢æ€** | `volumeMode`        | 99% é€‰ `Filesystem`ã€‚é™¤éä½ åœ¨æè¶…é«˜æ€§èƒ½æ•°æ®åº“æˆ–è™šæ‹ŸåŒ–é•œåƒï¼Œæ‰ä¼šå»ç¢° `Block`ï¼ˆè£¸å—è®¾å¤‡ï¼‰ã€‚
- é€‰å‹å†³ç­–æ ‘ï¼šä»€ä¹ˆæ—¶å€™ç”¨ä»€ä¹ˆï¼Ÿ
- 1. **å¦‚æœä½ åœ¨å…¬æœ‰äº‘ï¼ˆé˜¿é‡Œäº‘/AWSï¼‰ï¼š**
- - **é¦–é€‰ï¼š** äº‘ç›˜ CSIï¼ˆå¦‚é˜¿é‡Œäº‘ ESSDï¼‰ã€‚
- - **ç†ç”±ï¼š** ç¨³å®šï¼Œæ”¯æŒåŠ¨æ€åˆ›å»ºï¼Œè¿ç»´æˆæœ¬è¿‘ä¹ä¸º 0ã€‚
- 2. **å¦‚æœä½ åœ¨ç‰©ç†æœºæˆ¿ï¼ˆç§æœ‰äº‘ï¼‰ï¼š**
- - **é«˜æ€§èƒ½/å¤§æ•°æ®ï¼ˆES/ClickHouseï¼‰ï¼š** å¿…é¡»ç”¨ **Local PV**ã€‚é…åˆ `WaitForFirstConsumer`ï¼ŒæŠŠ IO å‹æ¦¨åˆ°æè‡´ã€‚
- - **å…±äº«é…ç½®/æ™®é€šä¸šåŠ¡ï¼ˆæ—¥å¿—ã€ä¸Šä¼ æ–‡ä»¶ï¼‰ï¼š** ç”¨ **NFS**ã€‚è™½ç„¶ Lowï¼Œä½†çœŸçš„å¥½ä¿®ã€‚
- - **æ ¸å¿ƒæ•°æ®åº“ï¼š** å»ºè®®ç”¨ **Ceph (RBD)**ï¼Œå¦‚æœä½ æ‰‹åº•ä¸‹çš„å…„å¼Ÿèƒ½æå®š Ceph çš„è¿ç»´ã€‚
- StatefulSet çš„â€œçµé­‚è€¦åˆâ€
- - **é€»è¾‘ï¼š** StatefulSet é…åˆ `volumeClaimTemplates`ã€‚
- - **ç°è±¡ï¼š** Pod-0 æ°¸è¿œç»‘å®š PVC-0ã€‚Pod æ­»äº†é‡å¯ï¼Œåå­—è¿˜æ˜¯ Pod-0ï¼Œå“ªæ€•é£˜åˆ°ç«æ˜Ÿå»ï¼Œå®ƒä¹Ÿè¦å›æ¥æ‰¾ PVC-0ã€‚
- - **æ„ä¹‰ï¼š** è¿™æ‰æ˜¯çœŸæ­£çš„â€œçŠ¶æ€â€ï¼Œä¹Ÿæ˜¯æ•°æ®åº“èƒ½åœ¨ K8S è·‘èµ·æ¥çš„åŸºç¡€ã€‚
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # æŒ‚è½½åˆ° 10.0.0.101 æœåŠ¡å™¨ /data/sc-nfs ç›®å½•
- mount nfs.wang.org:/data/sc-nfs  /mnt
- # æ·»åŠ åŸŸåè§£æ
- sed -i 's#^10.0.0.101.*#10.0.0.101 master1.wang.org master1 nfs.wang.org#'  /etc/hosts && grep master1 /etc/hosts
- # åç»­çš„æµ‹è¯•éªŒè¯
- kubectl  get pod -o wide
- redis-cli -h 10.244.1.11
- # ç»§ç»­æµ‹è¯•ï¼Œæ”¹æ¢èŠ‚ç‚¹ï¼ŒæŸ¥çœ‹æ•°æ®æ˜¯å¦æ”¹åœ¨ï¼
- kubectl  delete -f redis-deployment.yaml
- vi redis-deployment.yaml		# node1 æ”¹ä¸º node2 èŠ‚ç‚¹
- kubectl  apply -f redis-deployment.yaml
- kubectl  get pod -o wide		# æŸ¥çœ‹podçŠ¶æ€ï¼Œä»¥åŠpodåœ°å€
- redis-cli -h 10.244.4.2  get class		# åº”è¯¥èƒ½çœ‹åˆ° m65
- cat > storage-nfs-1.yaml  <<'eof'
-     nodeName: node1		# èŠ‚ç‚¹çš„/etc/hostsæ–‡ä»¶æˆ–DNSè§£ææ­¤åŸŸåï¼›èŠ‚ç‚¹å¯¹åº”çš„ä¸»æœºåå¿…é¡»ä¸ä¹‹ç›¸åŒ
-         server: nfs.wang.org		# æ³¨æ„:éœ€è¦å®¿ä¸»æœºèŠ‚ç‚¹/etc/hostsæ–‡ä»¶æˆ–DNSè§£ææ­¤åŸŸå,è€Œä¸æ˜¯ç”±Podé€šè¿‡coreDNSå®Œæˆè§£æ
- kubectl apply -f storage-nfs-1.yaml
- cat > redis-deployment.yaml <<'eof'
-       nodeName: node1		# èŠ‚ç‚¹çš„/etc/hostsæ–‡ä»¶æˆ–DNSè§£ææ­¤åŸŸåï¼›èŠ‚ç‚¹å¯¹åº”çš„ä¸»æœºåå¿…é¡»ä¸ä¹‹ç›¸åŒ
-           server: nfs.wang.org
- kubectl apply -f redis-deployment.yaml
- apiVersion: apps/v1             # èµ„æºç‰ˆæœ¬ï¼ŒDeployment å›ºå®šä½¿ç”¨ apps/v1
- kind: Deployment                # èµ„æºç±»å‹ï¼šéƒ¨ç½²ã€‚è´Ÿè´£ç»´æŒ Pod çš„æ•°é‡å’Œæ›´æ–°ç­–ç•¥
- metadata:
-   name: redis-nfs-deployment    # è¿™ä¸ª Deployment è‡ªå·±çš„åå­—
- spec:                           # ã€æ ¸å¿ƒè§„æ ¼ã€‘å®šä¹‰ä½ æœŸæœ›çš„çŠ¶æ€
-   replicas: 1                   # å‰¯æœ¬æ•°ï¼šåªè¿è¡Œ 1 ä¸ª Redis å®ä¾‹
-   selector:                     # ã€é€‰æ‹©å™¨ã€‘å‘Šè¯‰ Deployment å®ƒè¯¥ç®¡å“ªäº› Pod
-   template:                     # ã€æ¨¡ç‰ˆã€‘å®šä¹‰å…·ä½“è¦åˆ›å»ºå‡ºæ¥çš„ Pod æ˜¯ä»€ä¹ˆæ ·çš„
-     spec:                       # Pod å†…éƒ¨çš„å…·ä½“é…ç½®
-       nodeName: node1           # å¼ºåˆ¶æŒ‡å®šè¿è¡Œåœ¨åä¸º node1 çš„èŠ‚ç‚¹ä¸Šï¼ˆå»ºè®®æ…ç”¨ï¼Œé™¤éç¡®å®šèŠ‚ç‚¹åå‡†ç¡®ï¼‰
-       volumes:                  # å®šä¹‰è¿™ä¸ª Pod èƒ½å¤Ÿä½¿ç”¨çš„æ‰€æœ‰â€œç£ç›˜â€
-       - name: redisdatapath     # å·çš„è‡ªå®šä¹‰åç§°ï¼Œç»™ä¸‹é¢çš„ container å¼•ç”¨
-         nfs:                    # å­˜å‚¨ç±»å‹ï¼šç›´æ¥è¿æ¥ NFS æœåŠ¡å™¨
-           server: nfs.wang.org  # NFS æœåŠ¡å™¨åœ°å€ï¼ˆéœ€ç¡®ä¿ Worker èŠ‚ç‚¹èƒ½è§£ææ­¤åŸŸåï¼‰
-           path: /data/sc-nfs    # NFS ä¸Šçš„å…±äº«ç›®å½•
-       containers:
-       - name: redis             # å®¹å™¨åå­—
-         image: registry.cn-beijing.aliyuncs.com/wangxiaochun/redis:6.2.5
-         imagePullPolicy: IfNotPresent # é•œåƒæ‹‰å–ç­–ç•¥ï¼šå¦‚æœæœ¬åœ°æœ‰å°±ç”¨æœ¬åœ°çš„ï¼Œæ²¡æœ‰å†ä¸‹è½½
-         ports:
-         - containerPort: 6379   # å®¹å™¨å†…éƒ¨ç›‘å¬çš„ç«¯å£
-         volumeMounts:           # å°†ä¸Šé¢å®šä¹‰çš„å·â€œæ’â€è¿›å®¹å™¨çš„æŸä¸ªç›®å½•
-         - name: redisdatapath   # å¼•ç”¨ä¸Šé¢ volumes é‡Œçš„åå­—
-           mountPath: /data      # æ˜ å°„åˆ°å®¹å™¨å†…éƒ¨çš„ç›®å½•ã€‚Redis çš„æ•°æ®é»˜è®¤å­˜è¿™é‡Œ
- ![image-20251218162459707](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251218162459707.png)
- ![image-20251218162512918](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251218162512918.png)
- é€šè¿‡ kubectl patch å‘½ä»¤å¯ä»¥ç›´æ¥ä¿®æ”¹ PV çš„çŠ¶æ€ï¼Œä½¿å…¶ä» Released çŠ¶æ€å˜ä¸º Available çŠ¶æ€ã€‚
- kubectl patch persistentvolume <pv-name> -p '{"spec":{"claimRef": null}}'
- Recycleï¼šå½“å‰æ­¤é¡¹å·²åºŸå¼ƒï¼Œä¿ç•™PVï¼Œä½†æ¸…ç©ºå­˜å‚¨ç©ºé—´çš„æ•°æ®ï¼Œä»…æ”¯æŒNFSå’ŒhostPath
- # å‡†å¤‡NFSå…±äº«å­˜å‚¨
- # å‡†å¤‡PV,å®šåˆ¶ä¸€ä¸ªå…·ä½“ç©ºé—´å¤§å°çš„å­˜å‚¨å¯¹è±¡
- cat > storage-pv.yaml <<'eof'
-   name: pv-test  # æ­£ç¡®ï¼šåªåŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦
-   # storageClassName: manual   # ç”¨äºåˆ†ç±»ï¼ŒæŒ‡å®š pv ç»‘å®šåˆ°æŒ‡å®šçš„ pvc ï¼Œä¸ç”¨è¿™ä¸ªå‚æ•°åˆ†é…éšæœº
-     server: nfs.wang.org  # ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½è§£ææ­¤åŸŸå
- # è™½ç„¶æˆ‘ä»¬åœ¨åˆ›å»ºpvçš„æ—¶å€™æ²¡æœ‰æŒ‡å®šå›æ”¶ç­–ç•¥ï¼Œè€Œå…¶ç­–ç•¥è‡ªåŠ¨å¸®æˆ‘ä»¬é…ç½®äº†Retain
- kubectl apply -f storage-pv.yaml
- # å‡†å¤‡PVC,å®šä¹‰ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œè¯·æ±‚ç©ºé—´1Gi
- cat > storage-pvc.yaml <<'eof'
-   # storageClassName: manual   # ç”¨äºåˆ†ç±»ï¼ŒæŒ‡å®š pvc ç»‘å®šåˆ°æŒ‡å®šçš„ pv ï¼Œä¸ç”¨è¿™ä¸ªå‚æ•°åˆ†é…éšæœº
-       storage: 1Gi		 # #æ³¨æ„ï¼šè¯·æ±‚çš„èµ„æºå¤§å°å¿…é¡»åœ¨ pvèµ„æºçš„èŒƒå›´å†…ã€‚
- # ä¸€æ—¦å¯åŠ¨pvcä¼šè‡ªåŠ¨å»æœå¯»åˆé€‚çš„å¯ç”¨çš„pvï¼Œç„¶åç»‘å®šåœ¨ä¸€èµ·ï¼›å¦‚æœpvcæ‰¾ä¸åˆ°å¯¹åº”çš„pvèµ„æºï¼ŒçŠ¶æ€ä¼šä¸€ç›´å¤„äºpending
- kubectl apply -f storage-pvc.yaml
- # å‡†å¤‡ pod
- cat > storage-nginx-pvc.yaml <<'eof'
- kubectl apply -f storage-nginx-pvc.yaml
- # æ³¨æ„ï¼šåˆ é™¤æ—¶è¦æŒ‰é¡ºåºåˆ é™¤,å…ˆåˆ é™¤åº”ç”¨ pod å†åˆ é™¤ pvc æœ€ååˆ é™¤ pv ; å¦åˆ™ä¼šå‡ºç°å¡æ­»ç°è±¡
- kubectl delete -f storage-nginx-pvc.yaml
- kubectl delete -f storage-pvc.yaml
- kubectl delete -f storage-pv.yaml
- Provisionerï¼šå­˜å‚¨åˆ¶å¤‡å™¨ï¼›æ¯ä¸ª StorageClass éƒ½æœ‰ä¸€ä¸ªåˆ¶å¤‡å™¨ Provisioner ï¼Œç”¨äºæä¾›å­˜å‚¨é©±åŠ¨ï¼Œç”¨æ¥å†³å®šä½¿ç”¨å“ªä¸ªå·æ’ä»¶åˆ¶å¤‡ PVã€‚ è¯¥å­—æ®µå¿…é¡»æŒ‡å®šã€‚
- # Local PV ä¸ä¼šè‡ªåŠ¨åˆ›å»ºç›®å½• ( åœ¨æŒ‡å®šèŠ‚ç‚¹åˆ›å»º )
- cat > storage-sc-local-pv-pvc-mysql-pod.yaml <<'eof'
- provisioner: kubernetes.io/no-provisioner
-   persistentVolumeReclaimPolicy: Delete # å› ä¸ºé™æ€ç½®é…ï¼Œæ‰€ä»¥å½“PVCåˆ é™¤åï¼Œä¸ä¼šåˆ é™¤PVå’Œæ•°æ®
- kubectl apply -f storage-sc-local-pv-pvc-mysql-pod.yaml
- # å‡†å¤‡NFSå…±äº«å­˜å‚¨
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
- cat > rbac.yaml <<'eof'
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd --sort-by='{.metadata.creationTimestamp}'|tail
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- kubectl get all -n elastic-system
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd --sort-by='{.metadata.creationTimestamp}'|tail
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- kubectl get all -n elastic-system
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**** | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment ä¸º `requests` å’Œ `limits`ï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet
- # è¡¥ kube-proxy
- kubeadm init phase addon kube-proxy
- # åœ¨ master ä¸Šç”Ÿæˆæ–°çš„ join å‘½ä»¤ï¼š
- kubeadm token create --print-join-command
- kubeadm token delete uh7uw6.21za7ma0w9cbv1tq
- kubeadm token list
- curl -k https://kubeapi.wang.org:6443/version
- kubeadm join kubeapi.wang.org:6443 --token wd871e.i03nde59f3r3y3c5 \
-   --discovery-token-ca-cert-hash sha256:59f295053e6017ef2324c61d290e4f4d0652aad58fbd43f685e85ddc83b7f922 \
- k8s kubernetes-admin ç”¨æˆ·èµ‹æƒ ï¼ˆæ ¹æ®å®é™…æƒ…å†µå†³å®šï¼‰
- kubectl create clusterrolebinding kubernetes-admin \
-   --clusterrole=cluster-admin \
-   --user=kubernetes-admin
- åœ¨åšå…³äº ingress ç›¸å…³çš„å®éªŒæ—¶ï¼Œå‘ç°è€å¸ˆçš„å®éªŒç¯å¢ƒæ—©å·²å°† haproxy å’Œ keepalived é«˜å¯ç”¨ç§»é™¤ã€‚ä¸ºäº†åŒæ­¥è€å¸ˆçš„å®éªŒç¯å¢ƒï¼Œæˆ‘ä¹Ÿå°†è¿™ä¸¤ä¸ªæœåŠ¡ç§»é™¤ï¼Œï¼ˆè™½ç„¶æˆ‘ä¹Ÿæ˜¯ä¸€ä¸»ä¸‰ä»çš„æ¡†æ¶ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† haproxy å’Œ keepalived é«˜å¯ç”¨æœåŠ¡ï¼‰
- 10.0.0.101 kubeapi.wang.org kubeapi master1.wang.org master1 nfs.wang.org
- # å„èŠ‚ç‚¹æ‰§è¡Œ
- systemctl restart kubelet
- åœ¨ k8s é›†ç¾¤ ï¼ˆæ¶æ„ï¼šä¸€ä¸»ä¸‰ä»ï¼‰ä¸­éƒ¨ç½²ä¸€å¥— Prometheus ä½“ç³»ï¼Œå®Œæˆåç½‘ç«™æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æœåŠ¡éƒ½æ˜¯æ­£å¸¸ï¼Œæ²¡æœ‰ç›¸å…³æŠ¥é”™ï¼è¯¡å¼‚ï¼
- é€šè¿‡ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ prometheus-service.yaml ä¸­çš„ targetPort å‚æ•°ï¼Œå¼ºåˆ¶æŒ‡å®šç«¯å£å·ä¸º9090ï¼Œç„¶åé‡æ–°å£°æ˜è¿™ä¸ª YAML æ–‡ä»¶ï¼Œæ‰å‹‰å¼ºèƒ½è®¿é—® Prometheus ç½‘ç«™ï¼›
- ä½†æ˜¯è¿™æ˜¯æŠ•æœºå–å·§ï¼Œå› ä¸ºçœŸæ­£çš„åŸå› ä¸æ˜¯è¿™ä¸ªï¼æ­£æ‰€è°“å‰é€”æ˜¯å…‰æ˜çš„ï¼Œé“è·¯æ˜¯æ›²æŠ˜çš„ï¼Œé“ºå«äº†å‰è¿›çš„é˜¶æ¢¯ï¼›
- åç»­ä¿®æ­£å›æ¥ï¼Œå°†ç›®å…‰è½¬å‘ä¿®æ”¹ CR å®ä¾‹ï¼Œä½†æ˜¯å‘ç°æœ‰ Operator å·¡å›æ ¡æ­£ï¼›
- æ­¤æ—¶æ¸æ¸èµ°å‘äº†æ­£è§„ï¼Œå·²ç»åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ï¼›ä¿®æ”¹åå£°æ˜è¿™ä¸ªæ¸…å•æ–‡ä»¶ï¼Œç”Ÿæˆ CR å®ä¾‹ï¼›
- åœ¨ä¿®æ”¹ CR æ¸…å•æ–‡ä»¶ä¸­ï¼ŒçŸ¥é“äº†å…³äºæŸ¥çœ‹ CRD æ”¯æŒçš„å­—æ®µã€‚
- ç”±äºæ²¡æœ‰å­˜æ´»æ¢é’ˆå’Œå°±ç»ªæ¢é’ˆçš„å­—æ®µï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ·»åŠ  containers å­—æ®µï¼Œåœ¨è¯¥å­—æ®µä¸­æ·»åŠ éœ€è¦çš„æ¢é’ˆé…ç½®ï¼
- åœ¨å¯»æ‰¾çœŸç›¸çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å›°éš¾çš„è«è¿‡äºæ²¡æœ‰ç›¸å…³çš„æŠ¥é”™æç¤ºï¼Œä¸€ç‰‡è™šå‡çš„ Ready å’Œ Runningã€‚é›†ç¾¤å·²å¤±æ˜ï¼Œæ—¥å¿—åœ¨æ²‰é»˜ï¼Œç„¦æ€¥çš„æ”»åŸç‹®åœ¨æ’éšœï¼ï¼ï¼
- ä¿®æ”¹é…ç½®å¿…é¡»èµ° CRD/CR è·¯å¾„ï¼Œä¸¥ç¦ç›´æ¥åŠ¨åº•å±‚èµ„æºã€‚
- Prometheus Operator ä¸ºäº†ä¿æŒçµæ´»æ€§ï¼Œæä¾›äº†ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±é—¨â€â€”â€”ä¹Ÿå°±æ˜¯è¿™ä¸ª containers å­—æ®µã€‚å®ƒå…è®¸ä½ é€šè¿‡ Strategic Merge Patchï¼ˆç­–ç•¥æ€§åˆå¹¶è¡¥ä¸ï¼‰ æ¥ä¿®æ”¹ Operator åŸç”Ÿç”Ÿæˆçš„å®¹å™¨å±æ€§ã€‚
- è¿™ä¸ªç®—æ˜¯ä¸€ä»½ â€œ CoreDNS å¼‚å¸¸å¼•å‘çš„ Prometheus ç›‘æ§ä½“ç³»é›ªå´© â€ çš„æ•…éšœæ ·å¼ä¹‹ä¸€äº†ï¼
- # å¯¹ CR å®ä¾‹ç¼–è¾‘å¤±è´¥ï¼ŒåŸå› æ˜¯ CRD ä¸­æ²¡æœ‰å¯¹åº”çš„å­—æ®µæ¨¡æ¿æ ·å¼
- kubectl edit alertmanager main -n monitoring
- # æŸ¥çœ‹ Alertmanager çœŸæ­£çš„å®šä¹‰åˆ°åº•æ”¯æŒå“ªäº›å­—æ®µ
- kubectl explain alertmanager.spec
- # ä¿®æ”¹ CRD æ–‡ä»¶å‰ï¼Œé¦–å…ˆæ¸…é™¤åŸæ¥çš„èµ„æº
- kubectl delete  -f alertmanager-alertmanager.yaml
- # é€šè¿‡ containers ä¸‹çš„å®šä¹‰å­—æ®µæ·»åŠ å­˜æ´»ç­‰æ¢é’ˆ
- vi alertmanager-alertmanager.yaml
- # åº”ç”¨
- kubectl apply -f alertmanager-alertmanager.yaml
- - ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼Œä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ï¼Œä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- - service æš´éœ² wordpress çš„æœåŠ¡
- # æŸ¥çœ‹ coredns åœ°å€ ï¼ˆå¦‚æœè¾“å‡ºæ˜¯ 10.96.0.0/12 æˆ– 10.96.0.0/16ï¼Œé‚£ä¹ˆ 10.96.0.10 å°±æ˜¯åˆæ³•çš„ DNS åœ°å€ã€‚ï¼‰
- kubectl get pod kube-apiserver-master1 -n kube-system -o yaml | grep service-cluster-ip-range
- kubectl apply -f coredns.yaml
- # ä¸‹é¢æ˜¯æˆ‘ä¿®æ”¹å¥½çš„ YAML æ–‡ä»¶ï¼Œæ‹¿å»ç”¨æ—¶æ³¨æ„ coredns åœ°å€çš„å˜æ›´å“¦ï¼
- kubernetes cluster.local in-addr.arpa ip6.arpa {
-   name: coredns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     matchLabels:
-       k8s-app: kube-dns
-       app.kubernetes.io/name: coredns
-   template:
-     metadata:
-       labels:
-         k8s-app: kube-dns
-         app.kubernetes.io/name: coredns
-       affinity:
-          podAntiAffinity:
-            requiredDuringSchedulingIgnoredDuringExecution:
-            - labelSelector:
-                matchExpressions:
-                - key: k8s-app
-                  operator: In
-                  values: ["kube-dns"]
-              topologyKey: kubernetes.io/hostname
-   name: kube-dns
-   namespace: kube-system
-   labels:
-     k8s-app: kube-dns
-     kubernetes.io/cluster-service: "true"
-     kubernetes.io/name: "CoreDNS"
-     app.kubernetes.io/name: coredns
-   selector:
-     k8s-app: kube-dns
-     app.kubernetes.io/name: coredns
-   clusterIP: 10.96.0.10
- # æˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½ ï¼ˆè¿™ä¸ª no_root_squash ä¸€å®šè¦åŠ ï¼Œå¦åˆ™æ²¡æœ‰æƒé™ï¼‰
- # åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
- kubectl create ns sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
-   namespace: sc-nfs
- kubectl apply -f rbac.yaml
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment
- cat > nfs-client-provisioner.yaml <<'eof'
-   namespace: sc-nfs
-           value: k8s-sigs.io/nfs-subdir-external-provisioner #åç§°ç¡®ä¿ä¸ nfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
- kubectl apply -f nfs-client-provisioner.yaml
- kubectl get deployments.apps -n sc-nfs
- # æ³¨æ„:å¦‚æœå¤±è´¥,æ£€æŸ¥æ˜¯å¦workerèŠ‚ç‚¹å®‰è£…äº†nfs-client
- åˆ›å»º NFS èµ„æºçš„ StorageClass
- cat > nfs-StorageClass.yaml <<'eof'
- provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME'
- kubectl apply -f nfs-StorageClass.yaml
- cat > pvc.yaml <<'eof'
-   storageClassName: sc-nfs  #éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
- kubectl apply -f pvc.yaml
- # æ­¤æ—¶åº”è¯¥èƒ½çœ‹åˆ° PV è‡ªåŠ¨åˆ›å»ºå®Œæˆï¼Œå¹¶è‡ªåŠ¨ä¸ PVC ç»‘å®š
- cat > pod-test.yaml <<'eof'
- kubectl apply -f pod-test.yaml
- # K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- **K8s çš„é…ç½®ç®¡ç†ï¼Œæœ¬è´¨å°±æ˜¯ï¼š
- ConfigMap æ˜¯ **K8s ä¸­å­˜å‚¨éæ•æ„Ÿé…ç½®çš„ API å¯¹è±¡**
- ConfigMap æ›´æ–°ä¸æ˜¯é­”æ³•ï¼Œæ˜¯**è½¯é“¾æ¥åˆ‡æ¢**ã€‚å¦‚æœä½ çœ‹åˆ°æ–‡ä»¶æ²¡å˜ï¼Œå…ˆå»æŸ¥æŸ¥ä½ æ˜¯ç”¨ `env` æŒ‚è½½çš„è¿˜æ˜¯ `volume` æŒ‚è½½çš„ã€‚
- 2. **Reloader æ§åˆ¶å™¨**ï¼šä½¿ç”¨å¼€æºå·¥å…·ï¼ˆå¦‚ `stakater/Reloader`ï¼‰ï¼Œå½“ ConfigMap å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨å¸®ä½ è§¦å‘ Pod çš„æ»šåŠ¨æ›´æ–°ã€‚
- kubectl create configmap my-config --from-literal=key1=value1 --from-literal=key2=value2
- K8S é»˜è®¤çš„ Secret å¹¶ä¸æ˜¯çœŸæ­£çš„â€œåŠ å¯†â€ï¼Œå®ƒåªæ˜¯ **Base64 ç¼–ç **ã€‚é˜²å›å­ä¸é˜²å°äºº
- åœ¨çœŸæ­£çš„é‡‘èçº§æˆ–é«˜å®‰å…¨éœ€æ±‚ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…åˆ KMS å¯¹ Secret è¿›è¡Œé™æ€åŠ å¯†ã€‚å¦åˆ™ï¼Œåªè¦æœ‰äººèƒ½è¿› etcdï¼Œä½ çš„ç§˜å¯†å°±æ˜¯å…¨é€æ˜çš„ã€‚
- Secret çš„ä¸‰å¤§æ ¸å¿ƒç”¨æ³•
- **Service Account Token** | èº«ä»½ç‰Œ   | Pod æƒ³è°ƒç”¨ API Server æ—¶è‡ªæŠ¥å®¶é—¨çš„å‡­è¯ã€‚
- **docker-registry**       | è¿›é—¨æ¡   | ä½ çš„ç§æœ‰é•œåƒä»“åº“ï¼ˆå¦‚ Harborï¼‰çš„è´¦å·å¯†ç ï¼Œæ²¡å®ƒ Pod æ‹‰ä¸ä¸‹é•œåƒã€‚
- åœ¨ K8S é‡Œï¼ŒSecret è¿›å…¥ Pod ä¸»è¦æœ‰ä¸¤ç§å§¿åŠ¿ï¼šæŒ‚è½½ä¸ºæ–‡ä»¶ ï¼›æ˜ å°„ä¸ºç¯å¢ƒå˜é‡
- - ä¸åˆ›å»º Secretï¼ŒPod é‡Œå°±æ²¡ç§˜å¯†äº†ï¼Ÿ
- - æ¯ä¸ª Pod å¯åŠ¨æ—¶ï¼ŒK8S é»˜è®¤éƒ½ä¼šè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª Secretã€‚ä½ è¿› Pod æ•²ä¸€ä¸‹ `ls /var/run/secrets/kubernetes.io/serviceaccount/` çœ‹çœ‹ã€‚ è¿™å°±æ˜¯ **ServiceAccount (SA)**ã€‚å®ƒæ˜¯ Pod çš„èº«ä»½èº«ä»½è¯ã€‚
- - å¦‚æœä½ è¿™ä¸ª Pod æ ¹æœ¬ä¸éœ€è¦è°ƒ APIï¼ˆæ¯”å¦‚åªæ˜¯ä¸ªå‰ç«¯ Nginxï¼‰ï¼Œè®°å¾—åœ¨ Pod å®šä¹‰é‡ŒåŠ ä¸Š `automountServiceAccountToken: false`ã€‚**å°‘å¼€ä¸€ä¸ªå£å­ï¼Œå¤šä¸€åˆ†å®‰å…¨ã€‚**
- - è¿™æ˜¯ K8S 1.21 ä¹‹åè½¬æ­£çš„â€œç¥æŠ€â€ã€‚ ä»¥å‰ Secret æ˜¯é»˜è®¤å¯ä»¥éšæ—¶æ”¹çš„ï¼Œä½† Kubelet ä¼šä¸åœåœ°å»è½®è¯¢ etcd çœ‹å®ƒæ”¹æ²¡æ”¹ã€‚å¦‚æœä½ çš„é›†ç¾¤æœ‰å‡ ä¸‡ä¸ª Secretï¼Œetcd çš„å‹åŠ›èƒ½å¤§åˆ°è®©ä½ æƒ³ç ¸ç”µè„‘ã€‚
- - YAML é…ç½®ï¼š
-   kind: Secret
-   apiVersion: v1
-   metadata:
-     name: my-secret
-   immutable: true  # é‡ç‚¹åœ¨è¿™é‡Œ
-   data:
-     api-key: dXNlci1wYXNz
- - **å¥½å¤„**ï¼šæå¤§å‡è½» API Server è´Ÿæ‹…ï¼›é˜²æ­¢è¯¯æ“ä½œæ”¹äº†é…ç½®å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚
- å½“ Secret æŒ‚è½½åˆ° Pod æ—¶ï¼ŒK8S ä½¿ç”¨çš„æ˜¯ **tmpfs**ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰è¿™æ„å‘³ç€ï¼š
- ![image-20251219094822861](https://raw.githubusercontent.com/duanxueli08-cell/Obsidian-Images/main/img/image-20251219094822861.png)
- - ç”± K8s æ§åˆ¶
- - **ä¸€æ—¦ Pod åˆ›å»ºï¼Œæ— æ³•çƒ­ä¿®æ”¹**
- etcd
-  â””â”€â”€ ConfigMap / Secret
-       â””â”€â”€ kube-apiserver
-            â””â”€â”€ kubelet
-                 â””â”€â”€ Pod
-                      â”œâ”€â”€ env
-                      â””â”€â”€ volume
- - kubelet **watch API Server**
- - é…ç½®å˜åŒ– â†’ kubelet åŒæ­¥ â†’ å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- - **ä¸æ˜¯å®¹å™¨ä¸»åŠ¨æ‹‰**
- # ç¬¬ä¸€æ­¥ï¼šå®‰è£…è§„çŸ©** `kubectl apply -f my_crd.yaml`
- # ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ§åˆ¶å™¨**
- # ç¬¬ä¸‰æ­¥ï¼šæäº¤è®¢å•ï¼ˆåˆ›å»º CRï¼‰** `kubectl apply -f zhang_san.yaml`
- Operatorï¼šä¸ºæœ‰çŠ¶æ€æœåŠ¡æä¾›çš„ç§äººè®¢åˆ¶ ï¼ˆ CRD + Controller  ï¼‰ï¼›
- kubectl create -f https://download.elastic.co/downloads/eck/3.2.0/crds.yaml
- kubectl get crd | grep monitoring.coreos.com
- kubectl apply -f https://download.elastic.co/downloads/eck/3.2.0/operator.yaml
- # å‡†å¤‡ä¸šåŠ¡çš„åç§°ç©ºé—´
- kubectl create ns demo
- # å‡†å¤‡ elasticsearch-cluster æ¸…å•æ–‡ä»¶
- cat > operator-elasticsearch-cluster.yaml <<'eof'
- apiVersion: elasticsearch.k8s.elastic.co/v1
- kubectl apply -f operator-elasticsearch-cluster.yaml
- kubectl get all -n demo && kubectl get pv,pvc -n demo
- PASSWORD=$(kubectl get secret my-es-cluster-es-elastic-user -n demo -o jsonpath={.data.elastic} -n demo|base64 -d)
- kubectl run --env="PASSWORD=$PASSWORD" client-$RANDOM --image registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --restart=Never --command -- /bin/bash
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/health
- curl -u "elastic:$PASSWORD" -k https://my-es-cluster-es-http.demo:9200/_cat/nodes
- kubectl get pod -A          # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„ Pod
- kubectl get svc,deploy,cm   # ä¸€æ¬¡æ€§æŸ¥çœ‹ Service, Deployment, ConfigMap
- kubectl describe node node1 # æŸ¥çœ‹èŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€ã€èµ„æºå ç”¨å’Œäº‹ä»¶
- kubectl logs -f <pod-name> -n <namespace> 		# -f è¡¨ç¤ºæŒç»­è¾“å‡ºæ—¥å¿—ï¼›
- kubectl top node   # æŸ¥çœ‹èŠ‚ç‚¹ CPU/å†…å­˜
- kubectl top pod    # æŸ¥çœ‹ Pod æ¶ˆè€—
- kubectl version
- kubectl apply -f filename.yaml
- kubectl create ns my-namespace
- kubectl delete -f filename.yaml
- kubectl delete po <pod-name> -n <namespace>
- kubectl edit cm coredns -n kube-system
- kubectl scale deployment wordpress --replicas=3
- kubectl set image deployment/wordpress mysql=mysql:5.7
- 1. åŸºç¡€ä¸­çš„åŸºç¡€ï¼š`kubectl logs`
- - **å¸¸è§„ç”¨æ³•**ï¼š`kubectl logs <pod_name>`
- - `-p` (previous)ï¼š**æå…¶é‡è¦ï¼** æŸ¥çœ‹å®¹å™¨é‡å¯å‰ï¼ˆä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰çš„æ—¥å¿—ã€‚å¦‚æœ Pod å´©æºƒé‡å¯äº†ï¼Œä¸åŠ  `-p` ä½ åªèƒ½çœ‹åˆ°å¯åŠ¨åçš„æ—¥å¿—ï¼Œæ‰¾ä¸åˆ°å´©æºƒçš„åŸå› ã€‚
- - `-c` (container)ï¼šå¦‚æœä¸€ä¸ª Pod é‡Œæœ‰å¤šä¸ªå®¹å™¨ï¼ˆæ¯”å¦‚ Sidecar æ¨¡å¼ï¼‰ï¼Œå¿…é¡»æŒ‡å®šå®¹å™¨åã€‚
- 2. å®è§‚è§†è§’ï¼š`kubectl describe`
- - **æŒ‡ä»¤**ï¼š`kubectl describe pod <pod_name>`
- - **åº”ç”¨åœºæ™¯**ï¼šå¦‚æœ Pod çŠ¶æ€æ˜¯ `Pending`ã€`ImagePullBackOff` æˆ– `CrashLoopBackOff`ï¼Œè¿™æ—¶å€™ `kubectl logs` å¾€å¾€æ˜¯ç©ºçš„ï¼Œå› ä¸ºå®¹å™¨æ ¹æœ¬æ²¡è·‘èµ·æ¥ï¼ä½ å¾—ç”¨ `describe` å»çœ‹ K8s è°ƒåº¦å±‚çš„æ—¥å¿—ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ã€é•œåƒæ‹‰ä¸ä¸‹æ¥æˆ–è€…æŒ‚è½½å·å¤±è´¥å¯¼è‡´çš„ã€‚
- 3. å¤šå‰¯æœ¬è”åˆæŸ¥æ€ï¼š`stern` æˆ– `kubectl logs -l`
- - **è¿›é˜¶ç”¨æ³•**ï¼š`kubectl logs -l app=nginx -f`
- - **ç¬¬ä¸‰æ–¹ç¥å™¨ (Stern)**ï¼šè¿ç»´å¤§å‚æ ‡é…ï¼ŒæŒ‡ä»¤ï¼š`stern nginx`
- - **åº”ç”¨åœºæ™¯**ï¼šå®ƒèƒ½æŠŠåŒ¹é…æ ‡ç­¾çš„æ‰€æœ‰ Pod æ—¥å¿—èšåˆåœ¨ä¸€ä¸ªçª—å£ï¼Œå¹¶ä¸”ç”¨**ä¸åŒçš„é¢œè‰²**åŒºåˆ†ä¸åŒçš„ Podã€‚è¿™å¯¹äºæ’æŸ¥åˆ†å¸ƒå¼ç³»ç»Ÿçš„é“¾è·¯é—®é¢˜ç®€ç›´æ˜¯ç¥æŠ€ï¼
- 4. å®¿ä¸»æœºé™ç»´æ‰“å‡»ï¼š`journalctl`
- - **æŒ‡ä»¤**ï¼š`journalctl -u kubelet -f` æˆ–æŸ¥çœ‹ `/var/log/syslog` (Ubuntu) / `/var/log/messages` (CentOS)ã€‚
- - **åº”ç”¨åœºæ™¯**ï¼šå½“ `kubectl` å‘½ä»¤éƒ½æŠ¥é”™ï¼Œæˆ–è€… Pod è«åå…¶å¦™åœ¨å¤§è§„æ¨¡é‡å¯æ—¶ï¼Œå¯èƒ½æ˜¯å®¿ä¸»æœºçš„ `kubelet` å´©äº†ï¼Œæˆ–è€…æ˜¯ Docker/Containerd å¼•æ“æŒ‚äº†ã€‚è¿™æ—¶å€™ä½ è¦ SSH åˆ° Node èŠ‚ç‚¹ä¸Šå»çœ‹ç³»ç»Ÿæ—¥å¿—ã€‚
- | **æ’éšœé˜¶æ®µ** | **ä½¿ç”¨æŒ‡ä»¤** | **ä¾§é‡ç‚¹**    | **è§£å†³ä»€ä¹ˆé—®é¢˜**                        |
- | ------------ | ------------ | ------------- | --------------------------------------- |
- | **ç¬¬ä¸€æ­¥**   | `describe`   | äº‹ä»¶ (Events) | ä¸ºä»€ä¹ˆè·‘ä¸èµ·æ¥ï¼Ÿ(è°ƒåº¦/é•œåƒ/æŒ‚è½½)        |
- | **ç¬¬äºŒæ­¥**   | `logs`       | åº”ç”¨æ—¥å¿—      | ç¨‹åºé€»è¾‘æŠ¥é”™ã€ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿ä¸ä¸Šã€‚  |
- | **ç¬¬ä¸‰æ­¥**   | `logs -p`    | ä¸´ç»ˆé—è¨€      | å®¹å™¨åˆšæ‰ä¸ºä»€ä¹ˆçªç„¶é‡å¯äº†ï¼Ÿ              |
- | **ç¬¬å››æ­¥**   | `stern`      | èšåˆæ—¥å¿—      | å¤šä¸ªå‰¯æœ¬é‡Œï¼Œåˆ°åº•æ˜¯å“ªä¸ªåœ¨æŠ¥é”™ï¼Ÿ          |
- | **æœ€ç»ˆæ‰‹æ®µ** | `journalctl` | ç³»ç»Ÿæ—¥å¿—      | æ•´ä¸ªèŠ‚ç‚¹æˆ–è€… K8s æ ¸å¿ƒç»„ä»¶æ˜¯ä¸æ˜¯æ‹‰ç¨€äº†ï¼Ÿ |
- #### K8s ä¼˜åŒ–
- wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz
- tar xf k9s_Linux_amd64.tar.gz && ls
- ldd k9s
- mv k9s /usr/local/bin
- # Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
- helm completion bash > /etc/bash_completion.d/helm && exit
- 1. å‡¡äº‹å…ˆå£°æ˜ï¼Œå¿…ç•™ç—•è¿¹ï¼ˆGitOpsï¼‰
- åšæ³•ï¼šæ°¸è¿œä¸è¦åœ¨å‘½ä»¤è¡Œç”¨ kubectl edit ç›´æ¥æ”¹è¿è¡Œä¸­çš„é…ç½®ã€‚æ‰€æœ‰å˜æ›´éƒ½åº”è¯¥ä¿®æ”¹ YAML æ–‡ä»¶ï¼Œå¹¶æäº¤åˆ° Gitã€‚
- 2. å¿…é¡»ç»™èµ„æºè®¾ç½®é™åˆ¶ï¼ˆResource Quotasï¼‰
- åšæ³•ï¼šæ‰€æœ‰çš„ Deployment å¿…é¡»å†™ä¸Š requests å’Œ limitsï¼ˆCPU å’Œå†…å­˜ï¼‰ã€‚
- ç†ç”±ï¼šé˜²æ­¢æŸä¸ªè´ªå©ªçš„æœåŠ¡åƒæ‰æ•´å°å®¿ä¸»æœºçš„èµ„æºï¼Œå¯¼è‡´è¿ kubelet éƒ½è¢«æŒ¤æ­»ï¼ˆOOMï¼‰ï¼Œæœ€åå¼•å‘é›†ç¾¤é›ªå´©ã€‚
- 3. å¥åº·æ£€æŸ¥æ˜¯æ ‡é…ï¼ˆLiveness & Readinessï¼‰
- åšæ³•ï¼šå¿…é¡»é…ç½®å­˜æ´»æ£€æŸ¥ï¼ˆLivenessï¼‰å’Œå°±ç»ªæ£€æŸ¥ï¼ˆReadinessï¼‰ã€‚
- 4. å–„ç”¨ Label å’Œ Annotation
- åšæ³•ï¼šå»ºç«‹ä¸€å¥—è§„èŒƒçš„æ ‡ç­¾ä½“ç³»ï¼ˆå¦‚ app: nginx, env: prod, tier: frontendï¼‰ã€‚
- 5. æ°¸è¿œä¸è¦ç›¸ä¿¡â€œLatestâ€æ ‡ç­¾
- åšæ³•ï¼šé•œåƒç‰ˆæœ¬å·å¿…é¡»æ˜ç¡®ï¼ˆå¦‚ nginx:1.21.0ï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨ nginx:latestã€‚
- 1. è¿·æ‹ kubectl exec
- åä¹ æƒ¯ï¼šä¸€æœ‰é—®é¢˜å°±é’»è¿›å®¹å™¨é‡Œä¿®é…ç½®ã€æ”¹ä»£ç ã€‚
- 2. ä½¿ç”¨ Default å‘½åç©ºé—´
- åä¹ æƒ¯ï¼šæ‰€æœ‰çš„æœåŠ¡éƒ½å †åœ¨ default ä¸‹é¢ã€‚
- 3. ä»¥ Root èº«ä»½è¿è¡Œå®¹å™¨
- åä¹ æƒ¯ï¼šé•œåƒé‡Œç›´æ¥ç”¨ root ç”¨æˆ·è·‘ç¨‹åºã€‚
- 4. è£¸è·‘ Pod (Naked Pod)
- åä¹ æƒ¯ï¼šç›´æ¥ kubectl run ä¸€ä¸ªå•ç‹¬çš„ Podï¼Œè€Œä¸æ˜¯ç”¨ Deployment æˆ– StatefulSet ç®¡ç†ã€‚
- 5. å¿½ç•¥æ—¥å¿—æ”¶é›†å’Œç›‘æ§
- åä¹ æƒ¯ï¼šåªç®¡è·‘ï¼Œä¸çœ‹æ—¥å¿—ï¼Œä¸æ­ Prometheusã€‚
- åœ¨è¿™ä¸ªæ•…éšœä¹‹å‰è¿˜å‘ç”Ÿäº†å¦ä¸€ä¸ªæ•…éšœï¼Œå¯¼è‡´æˆ‘å¯¹ etc/kubernetes/manifests/kube-apiserver.yaml  æ–‡ä»¶è¿›è¡Œäº†æ‰‹å·¥ä¿®æ”¹ï¼›ä¹Ÿå› æ­¤å¯¼è‡´åç»­å¾ˆå¤šéº»çƒ¦ï¼
- `--authorization-mode` æ˜¯ç”¨æ¥å®šä¹‰é›†ç¾¤å¦‚ä½•å®¡æ‰¹ API è¯·æ±‚çš„ã€‚å½“ä½ ä¸ºäº†è§£å†³â€œæƒé™æŠ¥é”™â€è€Œå°†å…¶æ”¹ä¸º `AlwaysAllow` æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å…³é—­äº†é›†ç¾¤çš„æ‰€æœ‰æƒé™æ£€æŸ¥é—¨ç¦ã€‚
- è™½ç„¶è¿™è§£å†³äº†çœ¼ä¸‹çš„ `Forbidden` é”™è¯¯ï¼Œä½†ä¼šå¼•å‘ä¸€ç³»åˆ—éå¸¸ä¸¥é‡çš„è¿é”ååº”ï¼›
- Kubernetes çš„è®¸å¤šæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kubelet`ã€`scheduler`ã€`controller-manager`ï¼‰éƒ½æåº¦ä¾èµ– **Node** å’Œ **RBAC** é‰´æƒæ¨¡å¼æ¥ä¿è¯å„è‡ªçš„å·¥ä½œè¾¹ç•Œã€‚
- - **Kubelet çŠ¶æ€å¼‚å¸¸ï¼š** åŸæœ¬çš„é…ç½®é‡Œæœ‰ `Node` æ¨¡å¼ï¼Œè¿™æ˜¯ä¸“é—¨ç»™èŠ‚ç‚¹å¿ƒè·³å’ŒçŠ¶æ€æ›´æ–°ç”¨çš„ã€‚æ”¹ä¸º `AlwaysAllow` åï¼Œè™½ç„¶å®ƒä»¬è¿˜èƒ½å·¥ä½œï¼Œä½†å¤±å»äº†å®¡è®¡è¿™äº›ç»„ä»¶è¡Œä¸ºçš„èƒ½åŠ›ã€‚
- - **æ’ä»¶å¤±æ•ˆï¼š** æŸäº›ä¾èµ–ç‰¹å®š RBAC æƒé™æ‰èƒ½è¿è¡Œçš„ CNI ç½‘ç»œæ’ä»¶æˆ–å­˜å‚¨æ’ä»¶ï¼Œå¯èƒ½ä¼šå› ä¸ºæ•´ä½“æˆæƒé€»è¾‘çš„å˜åŒ–è€Œå‡ºç°è¡Œä¸ºå¼‚å¸¸ã€‚
- å¦‚æœåœ¨ `AlwaysAllow` æ¨¡å¼ä¸‹åˆ›å»ºäº†å¤§é‡èµ„æºï¼Œä¸€æ—¦å°†æ¥æƒ³æ”¹å› `RBAC`ï¼Œä¼šå‘ç°ä¹‹å‰â€œé¡ºæ‰‹â€éƒ¨ç½²çš„å¾ˆå¤šåº”ç”¨éƒ½ä¼šå› ä¸ºæ²¡æœ‰é…ç½®å¯¹åº”çš„ `Role` å’Œ `RoleBinding` è€Œé›†ä½“æŒ‚æ‰ã€‚
- ä¸‹é¢è¿™ä»½å¯ä»¥ç›´æ¥å½“ **kubeadm é›†ç¾¤æ€¥æ•‘æ‰‹å†Œ**ã€‚
- - ç°è±¡ï¼šcluster-info not found
- - æ ¹å› ï¼šbootstrap token æ²¡é…ç½®
- kubeadm init phase bootstrap-token
- - ç°è±¡ï¼šconfigmaps "kubeadm-config" not found
- - æ ¹å› ï¼šinit é˜¶æ®µæ²¡å®Œæ•´æ‰§è¡Œ ï¼›æˆ–è€…æ‰‹åŠ¨åˆ è¿‡ kube-system é‡Œçš„ CM
- kubeadm init phase upload-config kubeadm
- - ç°è±¡ï¼šUser "system:bootstrap:xxxx" cannot get resource "configmaps"
- - æ ¹å› ï¼šbootstrap RBAC è¢«åˆ  / æœªåˆ›å»º ï¼›æˆ–è€…`system:node-config-reader` ç¼ºå¤±
- kubectl get clusterrole system:node-config-reader \
- || kubectl create clusterrole binding system:node-config-reader \
-   --verb=get,list,watch \
-   --resource=configmaps
- kubectl get clusterrolebinding system:node-config-reader \
- || kubectl create clusterrolebinding system:node-config-reader \
-   --clusterrole=system:node-config-reader \
-   --group=system:bootstrappers:kubeadm:default-node-token
- # å¿…é¡»çœ‹åˆ°è¯¥å†…å®¹ï¼šGroup: system:bootstrappers:kubeadm:default-node-token
- - ç°è±¡ï¼š
-   configmaps "kubelet-config" not found
-   configmaps "kube-proxy" not found
- - æ ¹å› ï¼š
-   - init äº§ç‰©ç¼ºå¤±
-   - kubeadm init æ²¡è·‘å®Œæ•´
- # è¡¥ kubelet-config
- kubeadm init phase upload-config kubelet

[Timestamp: 2025/12/26 10:42:26]